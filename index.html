<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discovery Dispute Management Dashboard</title>
    <style>
        :root {
            --primary-blue: #0d6efd;
            --secondary-gray: #6c757d;
            --action-green: #198754;
            --background-light: #f8f9fa;
            --text-dark: #212529;
            --border-color: #dee2e6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background-light);
            color: var(--text-dark);
            line-height: 1.5;
            height: 100vh;
            overflow: hidden; /* Prevent body scrollbars, we'll handle scrolling inside views */
        }
        
        /* --- START: CORRECTED VIEW-SWITCHING LOGIC --- */
        /* By default, all top-level views are hidden. */
        #cases-dashboard-view, #dispute-list-view, #focus-view { 
            display: none; 
            width: 100%;
            height: 100vh;
            overflow-y: auto; /* Allow scrolling within each view if needed */
        }
        
        /* The body class determines which ONE view is shown. */
        body.cases-view-active #cases-dashboard-view { display: block; }
        body.dispute-list-active #dispute-list-view { display: block; }
        body.focus-mode-active #focus-view { display: flex; flex-direction: column; }
        /* --- END: CORRECTED VIEW-SWITCHING LOGIC --- */

        /* --- SHARED STYLES --- */
        .container { max-width: 95%; margin: 0 auto; padding: 20px; }
        header { padding: 20px; margin-bottom: 20px; }
        header h1 { font-size: 1.8rem; }
        header h2 { font-size: 1.1rem; font-weight: 400; color: var(--secondary-gray); }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background-color: var(--primary-blue); color: white; }
        .btn-primary:hover { background-color: #0b5ed7; }
        .btn-secondary { background-color: var(--secondary-gray); color: white; }
        .btn-secondary:hover { background-color: #5c636a; }
        .btn-action { background-color: var(--action-green); color: white; }
        .btn-action:hover { background-color: #157347; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* --- CASES DASHBOARD VIEW --- */
        #cases-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .case-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .case-card:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.12); }
        .case-card h3 { font-size: 1.2rem; margin-bottom: 8px; }
        .case-card p { color: var(--secondary-gray); }

        /* --- DISPUTE LIST VIEW --- */
        .action-bar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .table-container { background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow-x: auto; }
        .dispute-table { width: 100%; border-collapse: collapse; min-width: 1200px; }
        .dispute-table th, .dispute-table td { padding: 16px; border-bottom: 1px solid var(--border-color); vertical-align: top; text-align: left; }
        .dispute-table thead th { background-color: var(--background-light); font-weight: 600; }
        .dispute-table tbody tr { cursor: pointer; }
        .dispute-table tbody tr:hover { background-color: #e9ecef; }
        .col-number { width: 5%; } .col-request { width: 35%; } .col-objection { width: 60%; }
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(0,0,0,0.1); border-radius: 50%; border-top-color: var(--primary-blue); animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .progress-container { width: 100%; height: 12px; background-color: #e9ecef; border-radius: 6px; margin-top: 5px; overflow: hidden; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); }
        .progress-bar { height: 100%; width: 0%; background-color: var(--primary-blue); transition: width 0.4s ease; }
        .status-bar { padding: 12px; margin-bottom: 20px; border-radius: 6px; text-align: center; font-weight: 500; }
        .status-processing { background-color: #e9ecef; color: var(--text-dark); }
        .status-success { background-color: var(--action-green); color: white; }
        .status-error { background-color: #dc3545; color: white; }

        /* --- START: RIGID FOCUS VIEW LAYOUT --- */
        .focus-container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            
            flex-grow: 1; /* Make this fill the parent #focus-view */
            min-height: 0; 
            
            /* Use a rigid grid for the internal structure */
            display: grid;
            grid-template-rows: auto 120px 1fr; /* Header | Pinned-Height Request | Expanding Content */
            gap: 20px;
        }

        .focus-header {
            display: grid;
            grid-template-columns: auto 1fr auto; 
            align-items: center;
            gap: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .focus-header h3 {
            text-align: center;
            font-size: 1.4rem;
        }

        .focus-request {
            overflow-y: auto; /* Scroll internally if content is too long */
            background-color: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
        }

        .focus-content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            min-height: 0; 
        }
        
        .focus-col {
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .focus-col h4 {
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .text-pane {
            width: 100%;
            flex-grow: 1;
            overflow-y: auto;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: white;
            font-family: Georgia, 'Times New Roman', Times, serif;
            font-size: 16px;
            line-height: 1.6;
        }
        /* --- END: RIGID FOCUS VIEW LAYOUT --- */
    </style>
</head>
<body>

    <!-- VIEW 1: CASES DASHBOARD -->
    <div id="cases-dashboard-view">
        <div class="container">
            <header>
                <h1>All Cases</h1>
                <h2>Select a case to view its discovery disputes.</h2>
            </header>
            <div id="cases-grid"></div>
        </div>
    </div>

    <!-- VIEW 2: DISPUTE LIST (FOR A SINGLE CASE) -->
    <div id="dispute-list-view">
        <div class="container">
            <header>
                <h1 id="case-name-header">Case Name</h1>
                <h2 id="case-subtitle">Manage discovery disputes for this case.</h2>
            </header>
            <div id="status-bar" class="status-bar" style="display: none;"></div>
            <div id="progress-container" class="progress-container" style="display: none;">
                <div id="progress-bar" class="progress-bar"></div>
            </div>
            <div class="action-bar">
                <button class="btn btn-secondary" data-action="back-to-cases">← Back to All Cases</button>
                <button class="btn btn-primary" data-action="upload">Upload Opponent's Response</button>
                <!-- NEW BUTTON ADDED HERE -->
                <button class="btn btn-action" data-action="generate-all">Generate All Pending Replies</button>
            </div>
            <div class="table-container">
                <table class="dispute-table">
                    <thead>
                        <tr>
                            <th class="col-number">#</th>
                            <th class="col-request">Your Request (Summary)</th>
                            <th class="col-objection">Opponent's Objection</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- VIEW 3: FOCUS VIEW (FOR A SINGLE DISPUTE) -->
    <div id="focus-view">
        <div class="focus-container">
            <div class="focus-header">
                <button data-action="back-to-list" class="btn btn-secondary">← Back to Dispute List</button>
                <h3 id="focus-title">Request X of Y</h3>
                <div>
                    <button data-action="focus-prev" class="btn btn-primary">‹</button>
                    <button data-action="focus-next" class="btn btn-primary">›</button>
                </div>
            </div>
            <div id="focus-request-text" class="focus-request"></div>
            <div id="focus-content-grid" class="focus-content-grid">
                <!-- Content is dynamically built by renderFocusView() -->
            </div>
        </div>
    </div>
    <script>
        // --- DATA STORE ---
        let appData = {
            cases: [
                {
                    caseId: 'gardner-navajo',
                    caseName: "Gardner v. Navajo County, et al.",
                    requests: [ { id: 1, text: "For each employee or agent of Wexford... affirm or deny whether that person will testify about any spoken statements allegedly made by Amanda Gardner...", objection: null, reply: null }, { id: 2, text: "Identify all spoken or written statements made by each employee or agent of Wexford... regarding the treatment of Amanda Gardner.", objection: "Objection. Plaintiff's Interrogatory contains multiple subparts, is not limited in time or scope, and requests information...", reply: null }, { id: 3, text: "Under the contract by which Wexford undertook to provide medical care... describe which entities were responsible for the cost of medical services...", objection: "Objection. Plaintiff's interrogatory is unduly burdensome and calls for information that is a public record. Without...", reply: null }, { id: 4, text: "Identify the average number of patients in the Navajo County Adult Detention Facility during Wexford's work at the facility.", objection: "Objection. Plaintiff's interrogatory is not limited in time or scope, and is vague as the term “patients” is not...", reply: null }, { id: 5, text: "Identify all Wexford employees, agents, or independent contractors hired by Wexford who provided medical services at the Navajo County Jail...", objection: "Objection. Plaintiff's Interrogatory is not limited in time and scope, reasonably calls for...", reply: null }, { id: 6, text: "Identify every written protocol or policy in effect at the Navajo County Adult Detention Facility during Wexford's work at the facility.", objection: null, reply: null }, { id: 7, text: "Identify any entry or omission in the medical chart of Amanda Gardner that fails to conform to Wexford's policy on documentation.", objection: null, reply: null }, { id: 8, text: "Describe all communications with Navajo County Sheriff's Office detention staff about Amanda Gardner's health needs and transport.", objection: null, reply: null }, { id: 9, text: "Identify the principal or material facts you believe support any of the following defenses: (a) Plaintiff has failed to state a claim...", objection: null, reply: null }, { id: 10, text: "Identify the principal or material facts not mentioned in your response to Non-Uniform Interrogatory #9 that you believe support any other defense you are claiming.", objection: null, reply: null }, { id: 11, text: "Identify whether the care Wexford provided to Amanda Gardner... was performed in accordance with Wexford's national policy, practices, and training.", objection: null, reply: null }, { id: 12, text: "If you contend that any party or anyone else... is at fault for causing injuries to Amanda Gardner, describe the primary material facts that support your contention...", objection: null, reply: null }, { id: 13, text: "Have you ever had any communications from Navajo County or Navajo County Sheriff's Office criticizing your provision of correctional healthcare...", objection: null, reply: null }, { id: 14, text: "Identify for each witness you have identified... affirm or deny they have provided prior testimony under oath related to medical care.", objection: null, reply: null } ]
                },
                {
                    caseId: 'acme-vs-wile',
                    caseName: "Acme Corp. v. Wile E. Coyote",
                    requests: [
                        { id: 1, text: "Identify all rocket-powered devices purchased...", objection: "Overly broad.", reply: null },
                        { id: 2, text: "Describe the intended use of the 'Giant Rubber Band'...", objection: null, reply: null },
                    ]
                }
            ]
        };
        
        // --- STATE MANAGEMENT ---
        let currentCaseId = null;
        let currentFocusIndex = -1;

        // --- VIEW SWITCHING & RENDERING ---
        function showCasesDashboard() {
            document.body.className = 'cases-view-active';
            renderCasesDashboard();
        }

        function showDisputeListView(caseId) {
            currentCaseId = caseId;
            document.body.className = 'dispute-list-active';
            renderDisputeListView();
        }

        function showFocusView(requestIndex) {
            currentFocusIndex = requestIndex;
            document.body.className = 'focus-mode-active';
            renderFocusView();
        }
        
        function renderCasesDashboard() {
            const grid = document.getElementById('cases-grid');
            grid.innerHTML = '';
            appData.cases.forEach(c => {
                const unresolved = c.requests.filter(r => r.objection && !r.reply).length;
                const total = c.requests.length;
                const card = document.createElement('div');
                card.className = 'case-card';
                card.dataset.caseId = c.caseId;
                card.innerHTML = `<h3>${c.caseName}</h3><p>${unresolved} of ${total} disputes need a reply.</p>`;
                grid.appendChild(card);
            });
        }

        function renderDisputeListView() {
                const caseData = appData.cases.find(c => c.caseId === currentCaseId);
                if (!caseData) return showCasesDashboard();

                document.getElementById('case-name-header').textContent = caseData.caseName;
                const tableBody = document.getElementById('table-body');
                tableBody.innerHTML = '';

                caseData.requests.forEach((request, index) => {
                    const row = document.createElement('tr');
                    row.dataset.caseId = caseData.caseId;
                    row.dataset.index = index;
                    
                    const hasObjection = request.objection && request.objection.trim() !== '';
                    const hasReply = request.reply && request.reply.trim() !== '';
                    
                    let statusIcon = '';
                    let statusColor = '';
                    
                    if (hasObjection) {
                        if (hasReply) {
                            statusIcon = '✔';
                            statusColor = 'var(--action-green)';
                        } else {
                            statusIcon = '!';
                            statusColor = '#ffc107'; // A standard warning yellow
                        }
                    } else {
                        statusIcon = '—'; // An em-dash for "not applicable"
                        statusColor = '#dc3545'; // A standard error red
                    }
                    
                    const objectionText = hasObjection 
                        ? (request.objection || '').substring(0, 100) + '...' 
                        : '<i>No objection provided.</i>';

                    row.innerHTML = `
                        <td class="col-number">
                            <span style="color: ${statusColor}; font-weight: bold; display: inline-block; width: 1.5em; text-align: center;">${statusIcon}</span>
                            ${request.id}
                        </td>
                        <td class="col-request">${(request.text || '').substring(0, 80)}...</td>
                        <td class="col-objection">${objectionText}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }

        function renderFocusView() {
            const caseData = appData.cases.find(c => c.caseId === currentCaseId);
            const request = caseData.requests[currentFocusIndex];
            if (!request) return showDisputeListView(currentCaseId);
            
            document.getElementById('focus-title').textContent = `Request ${request.id} of ${caseData.requests.length}`;
            document.getElementById('focus-request-text').textContent = request.text;
            const container = document.getElementById('focus-content-grid');
            
            container.innerHTML = `
                <div class="focus-col">
                    <h4>Opponent's Objection</h4>
                    <textarea id="focus-objection-textarea" class="text-pane">${request.objection || ''}</textarea>
                </div>
                <div class="focus-col">
                     <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4>AI-Generated Replies</h4>
                        <button data-action="focus-generate" class="btn btn-action">Generate</button>
                    </div>
                    <div id="focus-reply-editor" class="text-pane" contenteditable="true">${request.reply || ''}</div>
                </div>
            `;
        }

        // --- NAVIGATION & DATA HANDLING ---
        function goBack() {
            if (document.body.classList.contains('focus-mode-active')) {
                showDisputeListView(currentCaseId);
            } else if (document.body.classList.contains('dispute-list-active')) {
                showCasesDashboard();
            }
        }
        
        function navigateFocus(direction) {
            if (!document.body.classList.contains('focus-mode-active')) return;
            const caseData = appData.cases.find(c => c.caseId === currentCaseId);
            if (!caseData) return;

            const currentRequest = caseData.requests[currentFocusIndex];
            currentRequest.objection = document.getElementById('focus-objection-textarea').value;
            currentRequest.reply = document.getElementById('focus-reply-editor').innerHTML;
            
            const newIndex = currentFocusIndex + direction;
            if (newIndex >= 0 && newIndex < caseData.requests.length) {
                showFocusView(newIndex);
            }
        }
        
        async function handleGenerateReplies() {
            const button = document.querySelector('[data-action="focus-generate"]');
            const replyEditor = document.getElementById('focus-reply-editor');
            const caseData = appData.cases.find(c => c.caseId === currentCaseId);
            const request = caseData.requests[currentFocusIndex];
            const objectionText = document.getElementById('focus-objection-textarea').value.trim();

            if (!objectionText) { alert("Please enter an objection first."); return; }
            
            request.objection = objectionText;
            button.disabled = true;
            button.innerHTML = '<div class="loading-spinner"></div>';
            replyEditor.innerHTML = '';

            try {
                const payload = { requestText: request.text, objectionText: objectionText };
                const result = await window.electronAPI.askGemini(payload);
                if (result.success) {
                    request.reply = result.html;
                    replyEditor.innerHTML = result.html;
                } else {
                    replyEditor.innerHTML = `<div style="color:red;">Error: ${result.error}</div>`;
                }
            } catch (error) {
                replyEditor.innerHTML = `<div style="color:red;">A critical error occurred: ${error.message}</div>`;
            } finally {
                button.disabled = false;
                button.textContent = 'Generate';
            }
        }

        // --- NEW: BATCH GENERATION HANDLER ---
        async function handleGenerateAllReplies() {
            const button = document.querySelector('[data-action="generate-all"]');
            const statusBar = document.getElementById('status-bar');
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            
            const caseData = appData.cases.find(c => c.caseId === currentCaseId);
            if (!caseData) return;

            const requestsToProcess = caseData.requests.filter(r => r.objection && !r.reply);

            if (requestsToProcess.length === 0) {
                alert("No pending replies to generate.");
                return;
            }

            const totalToProcess = requestsToProcess.length;
            button.disabled = true;
            button.innerHTML = '<div class="loading-spinner"></div> Generating...';
            statusBar.textContent = `Preparing to generate ${totalToProcess} replies...`;
            statusBar.className = 'status-bar status-processing';
            statusBar.style.display = 'block';
            progressBar.style.width = '0%';
            progressContainer.style.display = 'block';

            try {
                let completedCount = 0;
                for (const request of requestsToProcess) {
                    completedCount++;
                    statusBar.textContent = `Generating reply ${completedCount} of ${totalToProcess} (for Request #${request.id})...`;
                    
                    const payload = { requestText: request.text, objectionText: request.objection };
                    const result = await window.electronAPI.askGemini(payload);

                    if (result.success) {
                        request.reply = result.html; // Update the data model directly
                    } else {
                        request.reply = `<div style="color:red;">Error generating reply: ${result.error}</div>`;
                        console.error(`Failed to generate reply for request #${request.id}`, result.error);
                    }
                    
                    const percentage = (completedCount / totalToProcess) * 100;
                    progressBar.style.width = `${percentage}%`;
                }

                statusBar.textContent = 'All pending replies have been generated.';
                statusBar.className = 'status-bar status-success';
                setTimeout(() => {
                    statusBar.style.display = 'none';
                    progressContainer.style.display = 'none';
                }, 5000);

            } catch (error) {
                statusBar.textContent = `A critical error occurred: ${error.message}`;
                statusBar.className = 'status-bar status-error';
            } finally {
                button.disabled = false;
                button.textContent = "Generate All Pending Replies";
                renderDisputeListView(); // Re-render the table to show new status icons
            }
        }

        // --- INITIALIZATION & EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', showCasesDashboard);

        document.body.addEventListener('click', (event) => {
            const target = event.target;
            const caseCard = target.closest('.case-card');
            const disputeRow = target.closest('#table-body tr');
            const action = target.dataset.action;

            if (caseCard) {
                showDisputeListView(caseCard.dataset.caseId);
            } else if (disputeRow) {
                showFocusView(parseInt(disputeRow.dataset.index));
            } else if (action) {
                switch(action) {
                    case 'back-to-cases': showCasesDashboard(); break;
                    case 'back-to-list': showDisputeListView(currentCaseId); break;
                    case 'focus-next': navigateFocus(1); break;
                    case 'focus-prev': navigateFocus(-1); break;
                    case 'focus-generate': handleGenerateReplies(); break;
                    case 'generate-all': handleGenerateAllReplies(); break; // <-- NEW
                    case 'upload': 
                        const currentCase = appData.cases.find(c => c.caseId === currentCaseId);
                        if (currentCase) {
                            window.electronAPI.uploadAndProcess(currentCase.requests);
                        }
                        break;
                }
            }
        });

        document.addEventListener('keydown', (event) => {
            if (!document.body.classList.contains('focus-mode-active')) return;

            const activeEl = document.activeElement;
            const isEditingText = activeEl && (activeEl.tagName === 'TEXTAREA' || activeEl.isContentEditable);
            
            if (!isEditingText) {
                if (event.key === 'ArrowRight') {
                    event.preventDefault();
                    navigateFocus(1);
                } else if (event.key === 'ArrowLeft') {
                    event.preventDefault();
                    navigateFocus(-1);
                }
            }
        });
        
        window.electronAPI.onMenuAction((action) => {
            switch(action) {
                case 'go-back': goBack(); break;
                case 'nav-next': navigateFocus(1); break;
                case 'nav-prev': navigateFocus(-1); break;
            }
        });
        
        window.electronAPI.onUploadProgress((result) => {
            const statusBar = document.getElementById('status-bar');
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const button = document.querySelector('[data-action="upload"]');
            const currentCase = appData.cases.find(c => c.caseId === currentCaseId);
            if (!currentCase) return;

            switch (result.type) {
                case 'start':
                    statusBar.textContent = `Processing 1 of ${result.total}...`;
                    statusBar.className = 'status-bar status-processing';
                    statusBar.style.display = 'block';
                    progressBar.style.width = '0%';
                    progressContainer.style.display = 'block';
                    button.disabled = true;
                    button.innerHTML = '<div class="loading-spinner"></div> Preparing...';
                    break;
                case 'progress':
                    const requestToUpdate = currentCase.requests.find(r => r.id === result.data.id);
                    if (requestToUpdate) {
                        requestToUpdate.objection = result.data.objection;
                    }
                    renderDisputeListView();
                    const percentage = (result.current / result.total) * 100;
                    progressBar.style.width = `${percentage}%`;
                    statusBar.textContent = `Processing ${result.current} of ${result.total}...`;
                    break;
                case 'complete':
                    statusBar.textContent = 'Processing complete! All objections extracted.';
                    statusBar.className = 'status-bar status-success';
                    progressBar.style.width = '100%';
                    button.disabled = false;
                    button.innerHTML = "Upload Opponent's Response";
                    setTimeout(() => {
                        statusBar.style.display = 'none';
                        progressContainer.style.display = 'none';
                    }, 5000);
                    break;
                case 'error':
                    statusBar.textContent = `Error: ${result.message}`;
                    statusBar.className = 'status-bar status-error';
                    button.disabled = false;
                    button.innerHTML = "Upload Opponent's Response";
                    break;
                case 'cancel':
                    button.disabled = false;
                    button.innerHTML = "Upload Opponent's Response";
                    statusBar.style.display = 'none';
                    progressContainer.style.display = 'none';
                    break;
            }
        });
    </script>
</body>
</html>