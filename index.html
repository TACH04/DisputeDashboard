<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discovery Dispute Management Dashboard</title>
    <style>
        /* --- MODAL STYLES --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: var(--surface-primary);
            border-radius: 8px;
            padding: 24px;
            width: 100%;
            max-width: 500px;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.5rem;
            padding: 4px;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            margin-bottom: 24px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .input-group input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            background: var(--surface-primary);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px var(--accent-primary-hover);
        }

        .edit-button {
            opacity: 0;
            transition: opacity 0.2s ease;
            cursor: pointer;
            color: var(--text-tertiary);
            background: none;
            border: none;
            padding: 4px;
            margin-left: 8px;
        }

        .edit-button:hover {
            color: var(--text-primary);
        }

        .case-card:hover .edit-button,
        tr:hover .edit-button {
            opacity: 1;
        }

        /* --- THEME SYSTEM --- */
        :root {
            /* Light Theme (Default) */
            --surface-primary: #ffffff;
            --surface-secondary: #f7f7f8;
            --surface-tertiary: #ececf1;
            
            --text-primary: #2d2d2d;
            --text-secondary: #6e6e80;
            --text-tertiary: #acacbe;
            
            --border-light: #e5e5e5;
            --border-medium: #d9d9e3;
            --border-heavy: #c5c5d2;
            
            --accent-primary: #10a37f;
            --accent-primary-hover: #0e8e6d;
            --accent-secondary: #5436da;
            --accent-secondary-hover: #4827c7;
            
            --status-success: #10a37f;
            --status-warning: #fbbf24;
            --status-error: #ef4444;
            
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);

            /* Scrollbar Colors - Light Theme */
            --scrollbar-track: var(--surface-secondary);
            --scrollbar-thumb: var(--border-medium);
            --scrollbar-thumb-hover: var(--border-heavy);
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --surface-primary: #202123;
            --surface-secondary: #2d2d2d;
            --surface-tertiary: #343541;
            
            --text-primary: #ffffff;
            --text-secondary: #c5c5d2;
            --text-tertiary: #8e8ea0;
            
            --border-light: #404040;
            --border-medium: #4d4d4d;
            --border-heavy: #666666;
            
            /* Keep accent colors similar but slightly muted */
            --accent-primary: #10a37f;
            --accent-primary-hover: #13bf95;
            --accent-secondary: #5436da;
            --accent-secondary-hover: #6547e0;
            
            --status-success: #10a37f;
            --status-warning: #fbbf24;
            --status-error: #ef4444;
            
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3);

            /* Scrollbar Colors - Dark Theme */
            --scrollbar-track: var(--surface-tertiary);
            --scrollbar-thumb: var(--border-medium);
            --scrollbar-thumb-hover: var(--border-heavy);
        }

        /* Scrollbar Styling */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
        }

        /* Webkit Scrollbar Styling */
        *::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        *::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
            border-radius: 4px;
        }

        *::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 4px;
        }

        *::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover);
        }

        /* Remove scrollbar corner */
        *::-webkit-scrollbar-corner {
            background: transparent;
        }

        /* --- BASE STYLES --- */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--surface-secondary);
            color: var(--text-primary);
            line-height: 1.5;
            height: 100vh;
            overflow: hidden;
        }

        /* --- LAYOUT COMPONENTS --- */
        .container { 
            max-width: 95%; 
            margin: 0 auto; 
            padding: 20px;
        }

        header { 
            padding: 20px; 
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-light);
        }

        header h1 { 
            font-size: 1.8rem; 
            color: var(--text-primary);
            font-weight: 600;
        }

        header h2 { 
            font-size: 1.1rem; 
            font-weight: 400; 
            color: var(--text-secondary);
        }

        /* --- BUTTONS --- */
        .btn { 
            padding: 8px 16px; 
            border: none; 
            border-radius: 6px; 
            font-size: 14px; 
            font-weight: 500; 
            cursor: pointer; 
            transition: all 0.2s ease; 
            display: inline-flex; 
            align-items: center; 
            gap: 8px;
            background: var(--surface-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-medium);
        }

        .btn:hover {
            background: var(--surface-primary);
            border-color: var(--border-heavy);
        }

        .btn-primary { 
            background-color: var(--accent-primary); 
            color: white;
            border: none;
        }
        .btn-primary:hover { 
            background-color: var(--accent-primary-hover);
        }

        .btn-secondary { 
            background-color: var(--surface-tertiary);
            color: var(--text-primary);
        }
        .btn-secondary:hover { 
            background-color: var(--surface-primary);
        }

        .btn-action { 
            background-color: var(--accent-secondary); 
            color: white;
            border: none;
        }
        .btn-action:hover { 
            background-color: var(--accent-secondary-hover);
        }

        .btn:disabled { 
            opacity: 0.6; 
            cursor: not-allowed;
        }

        .btn-upload {
            background-color: #add8e6; /* Light blue */
            color: #2c3e50; /* Dark text for contrast */
            border: 1px solid #90c9e0;
        }
        .btn-upload:hover {
            background-color: #9ccbdb;
            border-color: #7fb8cc;
        }

        /* --- CARDS AND CONTAINERS --- */
        .case-card { 
            background: var(--surface-primary);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--border-light);
        }

        .case-card:hover { 
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
            border-color: var(--border-medium);
        }

        .table-container { 
            background-color: var(--surface-primary);
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            overflow-x: auto;
            border: 1px solid var(--border-light);
        }

        /* --- TABLES --- */
        .dispute-table { 
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        .dispute-table th, 
        .dispute-table td { 
            padding: 16px;
            border-bottom: 1px solid var(--border-light);
            color: var(--text-primary);
        }

        .dispute-table thead th { 
            background-color: var(--surface-secondary);
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.05em;
        }

        .dispute-table tbody tr { 
            cursor: pointer;
        }

        .dispute-table tbody tr:hover { 
            background-color: var(--surface-secondary);
        }

        /* --- PROGRESS INDICATORS --- */
        .progress-section {
            margin: 20px 0;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease-in-out;
            background: var(--surface-primary);
            border-radius: 8px;
            padding: 0 20px;
            border: 1px solid var(--border-light);
        }

        .progress-section.visible {
            opacity: 1;
            max-height: 100px;
            margin: 20px 0;
            padding: 20px;
        }

        .status-bar {
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 6px;
            text-align: center;
            font-weight: 500;
            background-color: var(--surface-secondary);
            color: var(--text-primary);
        }

        .status-bar.status-processing { 
            background-color: var(--surface-secondary);
            color: var(--text-primary);
        }
        .status-bar.status-success { 
            background-color: var(--status-success);
            color: white;
        }
        .status-bar.status-error { 
            background-color: var(--status-error);
            color: white;
        }

        .progress-container {
            width: 100%;
            height: 6px;
            background-color: var(--surface-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: var(--accent-primary);
            transition: width 0.4s ease;
        }

        /* --- FOCUS VIEW LAYOUT --- */
        .focus-container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            flex-grow: 1;
            min-height: 0;
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 20px;
        }

        .focus-header {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-light);
        }

        .focus-content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            min-height: 0;
            height: calc(100vh - 120px);
        }

        .focus-col {
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-height: 0;
            height: 100%;
        }

        .focus-col h4 {
            margin: 0;
            font-size: 1.1rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .request-section {
            background: var(--surface-primary);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 16px 20px;
            flex-shrink: 0;
        }

        .objection-section {
            background: var(--surface-primary);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 16px 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            min-height: 0; /* Important for Firefox */
            height: 100%;
        }

        #focus-objection-textarea {
            width: 100%;
            height: calc(100% - 50px);
            margin-top: 12px;
            padding: 0;
            font-family: inherit;
            font-size: 1rem;
            line-height: 1.6;
            color: var(--text-primary);
            background: transparent;
            border: none;
            resize: none;
            transition: all 0.2s ease;
            box-sizing: border-box;
            overflow-y: auto;
            -webkit-appearance: none; /* Removes default styling */
        }

        #focus-objection-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px var(--accent-primary-hover);
        }

        #focus-objection-textarea::placeholder {
            color: var(--text-tertiary);
        }

        .replies-section {
            background: var(--surface-primary);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .replies-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-light);
        }

        .replies-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .autosave-indicator {
            font-size: 0.9rem;
            color: var(--text-secondary);
            opacity: 0;
            transition: opacity 0.3s ease;
            margin-left: 12px;
        }

        .autosave-indicator.visible {
            opacity: 1;
        }

        .autosave-indicator .icon {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 6px;
            border-radius: 50%;
            background-color: var(--status-success);
        }

        .replies-content {
            padding: 16px 20px;
            overflow-y: auto;
            flex-grow: 1;
            font-family: Georgia, 'Times New Roman', Times, serif;
            font-size: 16px;
            line-height: 1.6;
            color: var(--text-primary);
        }

        /* --- THEME TOGGLE --- */
        .theme-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            padding: 10px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--surface-primary);
            border: 1px solid var(--border-medium);
            box-shadow: var(--shadow-md);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-lg);
        }

        .theme-toggle svg {
            width: 20px;
            height: 20px;
            fill: var(--text-primary);
        }

        /* --- VIEW MANAGEMENT --- */
        #cases-dashboard-view, 
        #dispute-list-view, 
        #focus-view, 
        #request-letters-view { 
            display: none;
            width: 100%;
            height: 100vh;
            overflow-y: auto;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        /* Active View States */
        body.cases-view-active #cases-dashboard-view,
        body.dispute-list-active #dispute-list-view,
        body.request-letters-active #request-letters-view {
            display: block;
            opacity: 1;
        }

        body.focus-mode-active #focus-view {
            display: flex;
            flex-direction: column;
            opacity: 1;
        }

        /* Grid Layouts */
        #cases-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px 0;
        }

        /* Action Bar */
        .action-bar {
            display: flex;
            gap: 12px;
            margin: 20px 0;
            flex-wrap: wrap;
            align-items: center;
            background: var(--surface-primary);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-sm);
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--surface-tertiary);
            border-radius: 50%;
            border-top-color: var(--accent-primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }

        /* Column Widths */
        .col-number { width: 5%; }
        .col-request { width: 35%; }
        .col-objection { width: 60%; }

        /* --- MODAL STYLES --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: var(--surface-primary);
            border-radius: 8px;
            padding: 24px;
            width: 100%;
            max-width: 500px;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.5rem;
            padding: 4px;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            margin-bottom: 24px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .input-group input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            background: var(--surface-primary);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px var(--accent-primary-hover);
        }

        /* Edit button styles */
        .edit-button {
            opacity: 0;
            transition: opacity 0.2s ease;
            cursor: pointer;
            color: var(--text-tertiary);
            background: none;
            border: none;
            padding: 4px;
            margin-left: 8px;
        }

        .edit-button:hover {
            color: var(--text-primary);
        }

        .case-card:hover .edit-button,
        tr:hover .edit-button {
            opacity: 1;
        }

        #letter-editor {
            background: white;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            outline: none;
        }
        
        #letter-editor:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px var(--accent-primary-hover);
        }

        .modal.letter-modal {
            max-width: 80%;
            height: 80vh;
            display: flex;
            flex-direction: column;
        }

        @media print {
            #letter-editor {
                border: none;
                padding: 0;
            }
        }

        /* Letter Editor View Styles */
        #response-letter-editor-view {
            display: none;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }

        body.letter-editor-active #response-letter-editor-view {
            display: block;
        }

        .letter-editor-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            height: calc(100vh - 200px);
            margin-top: 20px;
        }

        .letter-stats-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .stats-card {
            background: var(--surface-primary);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 20px;
        }

        .stats-card h3 {
            margin: 0 0 16px 0;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-light);
        }

        .stat-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .stat-label {
            color: var(--text-secondary);
        }

        .stat-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .generation-progress {
            background: var(--surface-primary);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 20px;
        }

        .progress-stages {
            margin: 20px 0;
        }

        .progress-stage {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .progress-stage.active {
            opacity: 1;
        }

        .progress-stage.completed .stage-dot {
            background-color: var(--status-success);
        }

        .stage-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--text-tertiary);
        }

        .stage-label {
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .letter-preview-panel {
            background: var(--surface-primary);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .preview-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-light);
            background: var(--surface-secondary);
        }

        .preview-controls, .export-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #zoom-level {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        #letter-preview-container {
            flex-grow: 1;
            overflow: auto;
            padding: 20px;
            background: var(--surface-secondary);
        }

        #letter-preview-content {
            background: white !important;
            padding: 40px;
            margin: 0 auto;
            max-width: 8.5in;
            min-height: 11in;
            box-shadow: var(--shadow-md);
            transform-origin: top center;
            /* Force black text on white background regardless of theme */
            color: black !important;
        }

        /* Override any theme-based color inheritance for the letter content */
        #letter-preview-content * {
            color: black !important;
            background-color: white !important;
        }

        /* Only exception is error messages */
        #letter-preview-content div[style*="color: var(--status-error)"] {
            color: var(--status-error) !important;
            background-color: white !important;
        }

        /* Version history styles */
        .version-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .version-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--border-light);
        }

        .version-item:last-child {
            border-bottom: none;
        }

        .version-info {
            flex-grow: 1;
        }

        .version-date {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .version-actions {
            display: flex;
            gap: 8px;
        }

        .letter-preview-container {
            background: white;
            padding: 40px;
            margin: 20px;
            box-shadow: var(--shadow-md);
        }
    </style>
</head>
<body>
    <!-- Add Theme Toggle Button -->
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
        <svg id="theme-icon" viewBox="0 0 24 24">
            <!-- Moon icon (for light mode) -->
            <path class="moon-icon" d="M21.53 15.93c-.16-.27-.61-.69-1.73-.49a8.46 8.46 0 01-1.88.13 8.409 8.409 0 01-5.91-2.82 8.068 8.068 0 01-1.44-8.66c.44-1.01.13-1.54-.09-1.76s-.77-.55-1.83-.11a10.318 10.318 0 00-6.32 10.21 10.475 10.475 0 007.04 8.99 10 10 0 002.89.55c.16.01.32.02.48.02a10.5 10.5 0 008.47-4.27c.67-.93.49-1.519.32-1.79z"/>
            <!-- Sun icon (for dark mode) -->
            <path class="sun-icon" d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0a.996.996 0 000-1.41l-1.06-1.06zm1.06-10.96a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/>
        </svg>
    </button>

    <!-- VIEW 1: CASES DASHBOARD -->
    <div id="cases-dashboard-view">
        <div class="container">
            <header style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>All Cases</h1>
                    <h2>Select a case to view its discovery disputes.</h2>
                </div>
                <button class="btn btn-primary" onclick="showAddCaseModal()">Add New Case</button>
            </header>
            <div id="cases-grid"></div>
        </div>
    </div>

    <!-- VIEW 2: REQUEST LETTERS MENU -->
    <div id="request-letters-view">
        <div class="container">
            <header>
                <h1 id="request-letters-header">Case Name</h1>
                <h2>Select a request letter to analyze.</h2>
            </header>
            <div class="action-bar">
                <button class="btn btn-secondary" data-action="back-to-cases">← Back to All Cases</button>
                <button class="btn btn-upload" data-action="upload-request">Upload New Request Letter</button>
            </div>
            <div class="progress-section" id="request-progress-section">
                <div id="request-status-bar" class="status-bar"></div>
                <div id="request-progress-container" class="progress-container">
                    <div id="request-progress-bar" class="progress-bar"></div>
                </div>
            </div>
            <div class="table-container">
                <table class="dispute-table">
                    <thead>
                        <tr>
                            <th style="width: 20%">Date Added</th>
                            <th style="width: 50%">Description</th>
                            <th style="width: 15%">Requests</th>
                            <th style="width: 15%">Status</th>
                        </tr>
                    </thead>
                    <tbody id="request-letters-table"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- VIEW 3: DISPUTE LIST (FOR A SINGLE REQUEST LETTER) -->
    <div id="dispute-list-view">
        <div class="container">
            <header>
                <h1 id="case-name-header">Case Name</h1>
                <h2 id="case-subtitle">Manage discovery disputes for this case.</h2>
            </header>
            <div class="action-bar">
                <button class="btn btn-secondary" data-action="back-to-letters">← Back to Request Letters</button>
                <button class="btn btn-upload" data-action="upload">Upload Opponent's Response</button>
                <button class="btn btn-action" data-action="generate-all">Generate All Pending Replies</button>
                <button class="btn btn-primary" data-action="build-letter">Build Response Letter</button>
            </div>
            <div class="progress-section" id="dispute-progress-section">
                <div id="dispute-status-bar" class="status-bar"></div>
                <div id="dispute-progress-container" class="progress-container">
                    <div id="dispute-progress-bar" class="progress-bar"></div>
                </div>
            </div>
            <div class="table-container">
                <table class="dispute-table">
                    <thead>
                        <tr>
                            <th class="col-number">#</th>
                            <th class="col-request">Your Request (Summary)</th>
                            <th class="col-objection">Opponent's Objection</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- VIEW 4: FOCUS VIEW -->
    <div id="focus-view">
        <div class="focus-container">
            <div class="focus-header">
                <button data-action="back-to-list" class="btn btn-secondary">← Back to Dispute List</button>
                <h3 id="focus-title">Request X of Y</h3>
                <div>
                    <button data-action="focus-prev" class="btn btn-primary">‹</button>
                    <button data-action="focus-next" class="btn btn-primary">›</button>
                </div>
            </div>
            <div class="focus-content-grid">
                <!-- Left Column: Request and Objection -->
                <div class="focus-col">
                    <div class="request-section">
                        <h4>Request</h4>
                        <div id="focus-request-text" style="margin-top: 12px;"></div>
                    </div>
                                        <div class="objection-section">
                        <h4>Opponent's Objection</h4>
                        <textarea id="focus-objection-textarea" style="width: 100%; font-family: inherit; font-size: 1rem; line-height: 1.6; color: var(--text-primary); background: var(--surface-primary); border: 1px solid var(--border-light); border-radius: 6px; padding: 12px; margin-top: 12px; min-height: 200px; resize: vertical;"></textarea>
                    </div>
                </div>
                
                <!-- Right Column: AI-Generated Replies -->
                <div class="focus-col">
                    <div class="replies-section">
                        <div class="replies-header">
                            <div class="replies-header-left">
                                <h4>AI-Generated Replies</h4>
                                <div class="autosave-indicator">
                                    <span class="icon"></span>
                                    <span class="text">Changes saved</span>
                                </div>
                            </div>
                            <button data-action="focus-generate" class="btn btn-action">Generate</button>
                        </div>
                        <div id="focus-reply-editor" class="replies-content" contenteditable="true"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Case Modal -->
    <div class="modal-overlay" id="add-case-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Add New Case</h3>
                <button class="modal-close" onclick="hideAddCaseModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="case-name-input">Case Name</label>
                    <input type="text" id="case-name-input" placeholder="Enter case name...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideAddCaseModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createNewCase()">Create Case</button>
            </div>
        </div>
    </div>

    <!-- Edit Case Modal -->
    <div class="modal-overlay" id="edit-case-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Edit Case Name</h3>
                <button class="modal-close" onclick="hideEditCaseModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="edit-case-name-input">Case Name</label>
                    <input type="text" id="edit-case-name-input">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideEditCaseModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveEditedCase()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Add Response Letter Modal -->
    <div class="modal-overlay" id="response-letter-modal">
        <div class="modal" style="max-width: 80%; height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3>Discovery Response Letter</h3>
                <div>
                    <button class="btn btn-secondary" onclick="exportResponseLetter('docx')">Export as DOCX</button>
                    <button class="btn btn-secondary" onclick="exportResponseLetter('pdf')">Export as PDF</button>
                    <button class="modal-close" onclick="hideResponseLetterModal()">&times;</button>
                </div>
            </div>
            <div class="modal-body" style="flex-grow: 1; overflow: auto; margin-bottom: 0;">
                <div id="letter-editor" contenteditable="true" style="width: 100%; height: 100%; padding: 20px; font-family: 'Times New Roman', Times, serif; font-size: 12pt; line-height: 1.5; white-space: pre-wrap;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideResponseLetterModal()">Close</button>
                <button class="btn btn-primary" onclick="saveResponseLetter()">Save Draft</button>
            </div>
        </div>
    </div>

    <!-- Add to the body, after other views -->
    <!-- VIEW 5: RESPONSE LETTER EDITOR -->
    <div id="response-letter-editor-view">
        <div class="container">
            <header>
                <h1 id="letter-editor-header">Response Letter Editor</h1>
                <h2 id="letter-editor-subtitle"></h2>
            </header>
            
            <div class="action-bar">
                <button class="btn btn-secondary" data-action="back-to-disputes">← Back to Disputes</button>
                <button class="btn btn-action" data-action="generate-letter">Build Response Letter</button>
            </div>

            <div class="letter-editor-grid">
                <!-- Left Column: Statistics and Controls -->
                <div class="letter-stats-panel">
                    <div class="stats-card">
                        <h3>Document Statistics</h3>
                        <div class="stat-item">
                            <span class="stat-label">Total Requests:</span>
                            <span id="stat-total-requests" class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">With Objections:</span>
                            <span id="stat-with-objections" class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">With Responses:</span>
                            <span id="stat-with-responses" class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Pending Responses:</span>
                            <span id="stat-pending" class="stat-value">0</span>
                        </div>
                    </div>

                    <div class="generation-progress" style="display: none;">
                        <h3>Generation Progress</h3>
                        <div class="progress-stages">
                            <div class="progress-stage" data-stage="setup">
                                <span class="stage-dot"></span>
                                <span class="stage-label">Setting Up</span>
                            </div>
                            <div class="progress-stage" data-stage="header">
                                <span class="stage-dot"></span>
                                <span class="stage-label">Generating Header</span>
                            </div>
                            <div class="progress-stage" data-stage="body">
                                <span class="stage-dot"></span>
                                <span class="stage-label">Processing Requests</span>
                            </div>
                            <div class="progress-stage" data-stage="conclusion">
                                <span class="stage-dot"></span>
                                <span class="stage-label">Adding Conclusion</span>
                            </div>
                            <div class="progress-stage" data-stage="formatting">
                                <span class="stage-dot"></span>
                                <span class="stage-label">Final Formatting</span>
                            </div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar"></div>
                        </div>
                        <div class="progress-status">Initializing...</div>
                    </div>
                </div>

                <!-- Right Column: PDF Preview -->
                <div class="letter-preview-panel">
                    <div class="preview-toolbar">
                        <div class="preview-controls">
                            <button class="btn btn-secondary" onclick="zoomIn()">
                                <svg width="16" height="16" viewBox="0 0 16 16">
                                    <path d="M8 4v8M4 8h8" stroke="currentColor" stroke-width="2"/>
                                </svg>
                            </button>
                            <button class="btn btn-secondary" onclick="zoomOut()">
                                <svg width="16" height="16" viewBox="0 0 16 16">
                                    <path d="M4 8h8" stroke="currentColor" stroke-width="2"/>
                                </svg>
                            </button>
                            <span id="zoom-level">100%</span>
                        </div>
                        <div class="export-controls">
                            <button class="btn btn-secondary" onclick="exportLetter('pdf')">Export PDF</button>
                            <button class="btn btn-secondary" onclick="exportLetter('docx')">Export DOCX</button>
                        </div>
                    </div>
                    <div id="letter-preview-container">
                        <div id="letter-preview-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        // --- DATA STORE ---
        // Global variables for autosave functionality
const AUTOSAVE_DELAY = 2000; // 2 seconds
let autoSaveTimeout = null;

const initialData = {
            cases: [
                {
                    caseId: 'gardner-navajo',
                    caseName: "Gardner v. Navajo County, et al.",
                    requestLetters: [
                        {
                            id: 'rog-set1',
                            dateAdded: '2024-03-15',
                            description: 'First Set of Interrogatories to Defendant Wexford',
                            requests: [
                                {
                                    id: 1,
                                    text: "For each employee or agent of Wexford... affirm or deny whether that person will testify about any spoken statements allegedly made by Amanda Gardner...",
                                    objection: null,
                                    reply: null
                                },
                                {
                                    id: 2,
                                    text: "Identify all spoken or written statements made by each employee or agent of Wexford... regarding the treatment of Amanda Gardner.",
                                    objection: "Objection. Plaintiff's Interrogatory contains multiple subparts, is not limited in time or scope, and requests information...",
                                    reply: null
                                }
                            ]
                        }
                    ]
                },
                {
                    caseId: 'acme-vs-wile',
                    caseName: "Acme Corp. v. Wile E. Coyote",
                    requestLetters: [
                        {
                            id: 'rog-set1',
                            dateAdded: '2024-03-10',
                            description: 'First Set of Interrogatories',
                            requests: [
                                {
                                    id: 1,
                                    text: "Identify all rocket-powered devices purchased...",
                                    objection: "Overly broad.",
                                    reply: null
                                },
                                {
                                    id: 2,
                                    text: "Describe the intended use of the 'Giant Rubber Band'...",
                                    objection: null,
                                    reply: null
                                }
                            ]
                        }
                    ]
                }
            ]
        };
        
        let appData = JSON.parse(JSON.stringify(initialData));
        
        // --- STATE MANAGEMENT ---
        let currentCaseId = null;
        let currentLetterId = null;
        let currentFocusIndex = -1;

        // State variables for editing
        let currentEditingCaseId = null;
        let currentEditingLetterId = null;

        // --- VIEW SWITCHING & RENDERING ---
        function showCasesDashboard() {
            document.body.className = 'cases-view-active';
            renderCasesDashboard();
        }

        function showRequestLettersView(caseId) {
            currentCaseId = caseId;
            currentLetterId = null;
            document.body.className = 'request-letters-active';
            renderRequestLettersView();
        }

        function showDisputeListView(letterId) {
            currentLetterId = letterId;
            document.body.className = 'dispute-list-active';
            renderDisputeListView();
        }

        function showFocusView(requestIndex) {
            currentFocusIndex = requestIndex;
            document.body.className = 'focus-mode-active';
            renderFocusView();
        }
        
        function renderCasesDashboard() {
            const grid = document.getElementById('cases-grid');
            grid.innerHTML = '';
            appData.cases.forEach(c => {
                const allRequests = c.requestLetters.reduce((acc, letter) => acc + letter.requests.length, 0);
                const unresolvedCount = c.requestLetters.reduce((acc, letter) => {
                    return acc + letter.requests.filter(r => r.objection && !r.reply).length;
                }, 0);
                
                const card = document.createElement('div');
                card.className = 'case-card';
                card.dataset.caseId = c.caseId;
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <h3>${c.caseName}</h3>
                        <button class="edit-button" onclick="event.stopPropagation(); showEditCaseModal('${c.caseId}')">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                <path d="M11.7 1.3c-.4-.4-1-.4-1.4 0L3 8.6V11h2.4l7.3-7.3c.4-.4.4-1 0-1.4l-1-1z" fill="currentColor"/>
                                <path d="M2 12h12v1H2z" fill="currentColor"/>
                            </svg>
                        </button>
                    </div>
                    <p>${unresolvedCount} of ${allRequests} disputes need a reply.</p>
                    <p style="color: var(--text-secondary); font-size: 0.9em; margin-top: 8px;">
                        ${c.requestLetters.length} Request Letter${c.requestLetters.length !== 1 ? 's' : ''}
                    </p>
                `;
                grid.appendChild(card);
            });
        }

        // --- STATUS UPDATING FUNCTIONS ---
        function updateRequestStatus(request, tableRow) {
            const hasObjection = request.objection && request.objection.trim() !== '';
            const hasReply = request.reply && request.reply.trim() !== '';
            
            let statusIcon = '';
            let statusColor = '';
            
            if (hasObjection) {
                if (hasReply) {
                    statusIcon = '✔';
                    statusColor = 'var(--action-green)';
                } else {
                    statusIcon = '!';
                    statusColor = '#ffc107';
                }
            } else {
                statusIcon = '—';
                statusColor = '#dc3545';
            }

            const statusSpan = tableRow.querySelector('.col-number span');
            if (statusSpan) {
                statusSpan.style.color = statusColor;
                statusSpan.textContent = statusIcon;
            }
        }

        function updateLetterStatus(letterData, letterRow) {
            const unresolvedCount = letterData.requests.filter(r => r.objection && !r.reply).length;
            const totalRequests = letterData.requests.length;
            const objectionCount = letterData.requests.filter(r => r.objection).length;
            
            let status = '';
            let statusColor = '';
            
            if (objectionCount === 0) {
                status = 'Awaiting Responses';
                statusColor = 'var(--secondary-gray)';
            } else if (unresolvedCount === 0) {
                status = 'All Replied';
                statusColor = 'var(--action-green)';
            } else {
                status = `${unresolvedCount} Need Reply`;
                statusColor = '#ffc107';
            }

            const statusCell = letterRow.querySelector('td:last-child span');
            if (statusCell) {
                statusCell.style.color = statusColor;
                statusCell.textContent = status;
            }
        }

        function renderRequestLettersView() {
            const caseData = appData.cases.find(c => c.caseId === currentCaseId);
            if (!caseData) return showCasesDashboard();

            document.getElementById('request-letters-header').textContent = caseData.caseName;
            const tableBody = document.getElementById('request-letters-table');
            tableBody.innerHTML = '';

            caseData.requestLetters.forEach(letter => {
                const row = document.createElement('tr');
                row.dataset.letterId = letter.id;
                
                const totalRequests = letter.requests.length;
                
                row.innerHTML = `
                    <td>${letter.dateAdded}</td>
                    <td style="display: flex; justify-content: space-between; align-items: center;">
                        ${letter.description}
                        <button class="edit-button" onclick="event.stopPropagation(); showEditLetterModal('${letter.id}')">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                <path d="M11.7 1.3c-.4-.4-1-.4-1.4 0L3 8.6V11h2.4l7.3-7.3c.4-.4.4-1 0-1.4l-1-1z" fill="currentColor"/>
                                <path d="M2 12h12v1H2z" fill="currentColor"/>
                            </svg>
                        </button>
                    </td>
                    <td>${totalRequests} Request${totalRequests !== 1 ? 's' : ''}</td>
                    <td><span></span></td>
                `;
                tableBody.appendChild(row);
                
                updateLetterStatus(letter, row);
            });
        }

        function renderDisputeListView() {
            const caseData = appData.cases.find(c => c.caseId === currentCaseId);
            if (!caseData) return showCasesDashboard();

            const letterData = caseData.requestLetters.find(l => l.id === currentLetterId);
            if (!letterData) return showRequestLettersView(currentCaseId);

            document.getElementById('case-name-header').textContent = `${caseData.caseName} - ${letterData.description}`;
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';

            letterData.requests.forEach((request, index) => {
                const row = document.createElement('tr');
                row.dataset.index = index;
                
                const objectionText = request.objection && request.objection.trim() !== ''
                    ? (request.objection || '').substring(0, 100) + '...' 
                    : '<i>No objection provided.</i>';

                row.innerHTML = `
                    <td class="col-number">
                        <span style="font-weight: bold; display: inline-block; width: 1.5em; text-align: center;"></span>
                        ${request.id}
                    </td>
                    <td class="col-request">${(request.text || '').substring(0, 80)}...</td>
                    <td class="col-objection">${objectionText}</td>
                `;
                tableBody.appendChild(row);
                
                // Update the status after creating the row
                updateRequestStatus(request, row);
            });
        }

        function renderFocusView() {
            const caseData = appData.cases.find(c => c.caseId === currentCaseId);
            if (!caseData) return showDisputeListView(currentLetterId);

            const letterData = caseData.requestLetters.find(l => l.id === currentLetterId);
            if (!letterData) return showDisputeListView(currentLetterId);

            const request = letterData.requests[currentFocusIndex];
            if (!request) return showDisputeListView(currentLetterId);
            
            document.getElementById('focus-title').textContent = `Request ${request.id} of ${letterData.requests.length}`;
            
            // Update request text
            const requestTextDiv = document.getElementById('focus-request-text');
            if (requestTextDiv) {
                requestTextDiv.textContent = request.text || '';
            }

            // Update objection textarea
            const objectionTextarea = document.getElementById('focus-objection-textarea');
            if (objectionTextarea) {
                objectionTextarea.value = request.objection || '';
            }

            // Update reply editor
            const replyEditor = document.getElementById('focus-reply-editor');
            if (replyEditor) {
                replyEditor.innerHTML = request.reply || '';
            }
        }
        
        async function navigateFocus(direction) {
            if (!document.body.classList.contains('focus-mode-active')) return;
            
            const caseData = appData.cases.find(c => c.caseId === currentCaseId);
            if (!caseData) return;

            const letterData = caseData.requestLetters.find(l => l.id === currentLetterId);
            if (!letterData) return;

            // Save current state before navigation
            const currentRequest = letterData.requests[currentFocusIndex];
            if (currentRequest) {
                const objectionTextarea = document.getElementById('focus-objection-textarea');
                const replyEditor = document.getElementById('focus-reply-editor');
                
                // Only update if the fields have actually changed
                if (objectionTextarea && objectionTextarea.value !== currentRequest.objection) {
                    currentRequest.objection = objectionTextarea.value;
                }
                if (replyEditor && replyEditor.innerHTML !== currentRequest.reply) {
                    currentRequest.reply = replyEditor.innerHTML;
                }
            }
            
            const newIndex = currentFocusIndex + direction;
            if (newIndex >= 0 && newIndex < letterData.requests.length) {
                currentFocusIndex = newIndex;
                renderFocusView();
            }
            await autoSave();
        }
        
        async function handleGenerateReplies() {
            const button = document.querySelector('[data-action="focus-generate"]');
            const replyEditor = document.getElementById('focus-reply-editor');
            const caseData = appData.cases.find(c => c.caseId === currentCaseId);
            const request = caseData.requestLetters[currentFocusIndex].requests[currentFocusIndex];
            const objectionText = document.getElementById('focus-objection-textarea').value.trim();

            if (!objectionText) { alert("Please enter an objection first."); return; }
            
            request.objection = objectionText;
            button.disabled = true;
            button.innerHTML = '<div class="loading-spinner"></div>';
            replyEditor.innerHTML = '';

            try {
                const payload = { requestText: request.text, objectionText: objectionText };
                const result = await window.electronAPI.askGemini(payload);
                if (result.success) {
                    request.reply = result.html;
                    replyEditor.innerHTML = result.html;
                    await autoSave();
                } else {
                    replyEditor.innerHTML = `<div style="color:red;">Error: ${result.error}</div>`;
                }
            } catch (error) {
                replyEditor.innerHTML = `<div style="color:red;">A critical error occurred: ${error.message}</div>`;
            } finally {
                button.disabled = false;
                button.textContent = 'Generate';
            }
        }

        async function handleGenerateAllReplies() {
            const button = document.querySelector('[data-action="generate-all"]');
            const progressSection = document.getElementById('dispute-progress-section');
            const statusBar = document.getElementById('dispute-status-bar');
            const progressBar = document.getElementById('dispute-progress-bar');
            
            const caseData = appData.cases.find(c => c.caseId === currentCaseId);
            if (!caseData) return;

            const letterData = caseData.requestLetters.find(l => l.id === currentLetterId);
            if (!letterData) return;

            const requestsToProcess = letterData.requests.filter(r => r.objection && !r.reply);

            if (requestsToProcess.length === 0) {
                alert("No pending replies to generate.");
                return;
            }

            const totalToProcess = requestsToProcess.length;
            button.disabled = true;
            button.innerHTML = '<div class="loading-spinner"></div> Generating...';
            
            // Show progress section
            progressSection.classList.add('visible');
            statusBar.textContent = `Preparing to generate ${totalToProcess} replies...`;
            statusBar.className = 'status-bar status-processing';
            progressBar.style.width = '0%';

            try {
                let completedCount = 0;
                for (const request of requestsToProcess) {
                    // Update progress for current request
                    const progress = (completedCount / totalToProcess) * 100;
                    statusBar.textContent = `Generating reply ${completedCount + 1} of ${totalToProcess} (Request #${request.id})...`;
                    progressBar.style.width = `${progress}%`;
                    
                    const payload = { requestText: request.text, objectionText: request.objection };
                    const result = await window.electronAPI.askGemini(payload);

                    if (result.success) {
                        request.reply = result.html;
                        
                        // Update status in dispute list view if visible
                        if (!document.body.classList.contains('focus-mode-active')) {
                            const disputeRow = document.querySelector(`#table-body tr[data-index="${letterData.requests.indexOf(request)}"]`);
                            if (disputeRow) {
                                updateRequestStatus(request, disputeRow);
                            }
                        }

                        // Update status in request letters view
                        const letterRow = document.querySelector(`#request-letters-table tr[data-letter-id="${letterData.id}"]`);
                        if (letterRow) {
                            updateLetterStatus(letterData, letterRow);
                        }
                        
                        // Update focus view if we're viewing this request
                        if (document.body.classList.contains('focus-mode-active')) {
                            const currentRequest = letterData.requests[currentFocusIndex];
                            if (currentRequest && currentRequest.id === request.id) {
                                const replyEditor = document.getElementById('focus-reply-editor');
                                if (replyEditor) {
                                    replyEditor.innerHTML = result.html;
                                }
                            }
                        }
                    } else {
                        request.reply = `<div style="color:red;">Error generating reply: ${result.error}</div>`;
                        console.error(`Failed to generate reply for request #${request.id}`, result.error);
                    }
                    
                    completedCount++;
                }

                // Update final progress
                statusBar.textContent = 'All pending replies have been generated!';
                statusBar.className = 'status-bar status-success';
                progressBar.style.width = '100%';

                setTimeout(() => {
                    progressSection.classList.remove('visible');
                }, 3000);

            } catch (error) {
                statusBar.textContent = `A critical error occurred: ${error.message}`;
                statusBar.className = 'status-bar status-error';
                setTimeout(() => {
                    progressSection.classList.remove('visible');
                }, 5000);
            } finally {
                button.disabled = false;
                button.textContent = "Generate All Pending Replies";
            }
        }

        // --- INITIALIZATION & EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', showCasesDashboard);

        document.body.addEventListener('click', (event) => {
            const target = event.target;
            const caseCard = target.closest('.case-card');
            const letterRow = target.closest('#request-letters-table tr');
            const disputeRow = target.closest('#table-body tr');
            const action = target.dataset.action;

            if (caseCard) {
                showRequestLettersView(caseCard.dataset.caseId);
            } else if (letterRow) {
                showDisputeListView(letterRow.dataset.letterId);
            } else if (disputeRow) {
                showFocusView(parseInt(disputeRow.dataset.index));
            } else if (action) {
                switch(action) {
                    case 'back-to-cases': showCasesDashboard(); break;
                    case 'back-to-letters': showRequestLettersView(currentCaseId); break;
                    case 'back-to-list': showDisputeListView(currentLetterId); break;
                    case 'focus-next': navigateFocus(1); break;
                    case 'focus-prev': navigateFocus(-1); break;
                    case 'focus-generate': handleGenerateReplies(); break;
                    case 'generate-all': handleGenerateAllReplies(); break;
                    case 'upload-request': window.electronAPI.uploadRequestLetter(); break;
                    case 'upload': 
                        const currentCase = appData.cases.find(c => c.caseId === currentCaseId);
                        const currentLetter = currentCase?.requestLetters.find(l => l.id === currentLetterId);
                        if (currentLetter) {
                            window.electronAPI.uploadAndProcess(currentLetter.requests);
                        }
                        break;
                }
            }
        });

        document.addEventListener('keydown', (event) => {
            if (!document.body.classList.contains('focus-mode-active')) return;

            const activeEl = document.activeElement;
            const isEditingText = activeEl && (activeEl.tagName === 'TEXTAREA' || activeEl.isContentEditable);
            
            if (!isEditingText) {
                if (event.key === 'ArrowRight') {
                    event.preventDefault();
                    navigateFocus(1);
                } else if (event.key === 'ArrowLeft') {
                    event.preventDefault();
                    navigateFocus(-1);
                }
            }
        });
        
        window.electronAPI.onMenuAction((action) => {
            switch(action) {
                case 'go-back': goBack(); break;
                case 'nav-next': navigateFocus(1); break;
                case 'nav-prev': navigateFocus(-1); break;
            }
        });
        
        // --- GLOBAL UI UPDATES ---
        function updateUIAfterObjectionProcessing(caseId, letterId, updatedRequests) {
            // Update the data store
            const caseData = appData.cases.find(c => c.caseId === caseId);
            if (!caseData) return;

            const letterData = caseData.requestLetters.find(l => l.id === letterId);
            if (!letterData) return;

            // Update the requests with new objections
            updatedRequests.forEach(obj => {
                const requestToUpdate = letterData.requests.find(r => r.id === obj.id);
                if (requestToUpdate) {
                    requestToUpdate.objection = obj.objection;
                }
            });

            // Update UI based on current view
            const currentView = document.body.className;
            switch (currentView) {
                case 'cases-view-active':
                    renderCasesDashboard();
                    break;
                case 'request-letters-active':
                    renderRequestLettersView();
                    break;
                case 'dispute-list-active':
                    renderDisputeListView();
                    break;
                case 'focus-mode-active':
                    // Only update if we're viewing the same request
                    if (currentCaseId === caseId && currentLetterId === letterId) {
                        renderFocusView();
                    }
                    break;
            }
        }

        // --- EVENT HANDLERS ---
        window.electronAPI.onUploadProgress((result) => {
            const progressSection = document.getElementById('dispute-progress-section');
            const statusBar = document.getElementById('dispute-status-bar');
            const progressBar = document.getElementById('dispute-progress-bar');
            const button = document.querySelector('[data-action="upload"]');

            // Store case and letter IDs at the time of upload
            const uploadCaseId = currentCaseId;
            const uploadLetterId = currentLetterId;

            const updateProgress = (message, progress) => {
                if (progressSection) {
                    statusBar.textContent = message;
                    statusBar.className = 'status-bar status-processing';
                    progressBar.style.width = `${progress}%`;
                }
            };

            switch (result.type) {
                case 'progress':
                    if (progressSection) {
                        progressSection.classList.add('visible');
                        button.disabled = true;
                        button.innerHTML = '<div class="loading-spinner"></div> Processing...';
                        updateProgress(result.message, result.progress);
                    }
                    break;

                case 'complete':
                    if (result.data && Array.isArray(result.data)) {
                        // Update UI across all views
                        updateUIAfterObjectionProcessing(uploadCaseId, uploadLetterId, result.data);
                    }
                    
                    if (progressSection) {
                        statusBar.className = 'status-bar status-success';
                        updateProgress('Processing complete! All objections extracted.', 100);
                        button.disabled = false;
                        button.innerHTML = "Upload Opponent's Response";
                        setTimeout(() => {
                            progressSection.classList.remove('visible');
                        }, 3000);
                    }
                    break;

                case 'error':
                    if (progressSection) {
                        progressSection.classList.add('visible');
                        statusBar.className = 'status-bar status-error';
                        updateProgress(`Error: ${result.message}`, 100);
                        button.disabled = false;
                        button.innerHTML = "Upload Opponent's Response";
                        setTimeout(() => {
                            progressSection.classList.remove('visible');
                        }, 5000);
                    }
                    break;

                case 'cancel':
                    if (progressSection && button) {
                        button.disabled = false;
                        button.innerHTML = "Upload Opponent's Response";
                        progressSection.classList.remove('visible');
                    }
                    break;
            }
        });

        window.electronAPI.onRequestProgress((result) => {
            const progressSection = document.getElementById('request-progress-section');
            const statusBar = document.getElementById('request-status-bar');
            const progressBar = document.getElementById('request-progress-bar');
            const button = document.querySelector('[data-action="upload-request"]');

            // Store case ID at the time of upload
            const uploadCaseId = currentCaseId;

            const updateProgress = (message, progress) => {
                if (progressSection) {
                    statusBar.textContent = message;
                    progressBar.style.width = `${progress}%`;
                }
            };

            switch (result.type) {
                case 'progress':
                    if (progressSection) {
                        progressSection.classList.add('visible');
                        button.disabled = true;
                        button.innerHTML = '<div class="loading-spinner"></div> Processing...';
                        updateProgress(result.message, result.progress);
                    }
                    break;

                case 'complete':
                    if (result.data && Array.isArray(result.data)) {
                        const caseData = appData.cases.find(c => c.caseId === uploadCaseId);
                        if (caseData) {
                            const newLetter = {
                                id: `rog-set${caseData.requestLetters.length + 1}`,
                                dateAdded: new Date().toISOString().split('T')[0],
                                description: `Set ${caseData.requestLetters.length + 1} of Interrogatories`,
                                requests: result.data.map(req => ({
                                    ...req,
                                    objection: null,
                                    reply: null
                                }))
                            };
                            caseData.requestLetters.push(newLetter);

                            // Update UI based on current view
                            const currentView = document.body.className;
                            switch (currentView) {
                                case 'cases-view-active':
                                    renderCasesDashboard();
                                    break;
                                case 'request-letters-active':
                                    if (currentCaseId === uploadCaseId) {
                                        renderRequestLettersView();
                                    }
                                    break;
                            }
                        }
                    }

                    if (progressSection) {
                        statusBar.className = 'status-bar status-success';
                        updateProgress('Processing complete! New request letter added.', 100);
                        button.disabled = false;
                        button.innerHTML = 'Upload Request Letter';
                        setTimeout(() => {
                            progressSection.classList.remove('visible');
                        }, 3000);
                    }
                    break;

                case 'error':
                    if (progressSection) {
                        progressSection.classList.add('visible');
                        statusBar.className = 'status-bar status-error';
                        updateProgress(`Error: ${result.message}`, 100);
                        button.disabled = false;
                        button.innerHTML = 'Upload Request Letter';
                        setTimeout(() => {
                            progressSection.classList.remove('visible');
                        }, 5000);
                    }
                    break;

                case 'cancel':
                    if (progressSection && button) {
                        button.disabled = false;
                        button.innerHTML = 'Upload Request Letter';
                        progressSection.classList.remove('visible');
                    }
                    break;
            }
        });

        // Add theme toggle functionality
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            
            // Save theme preference
            localStorage.setItem('theme', newTheme);
            
            // Update icon visibility
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const moonIcon = document.querySelector('.moon-icon');
            const sunIcon = document.querySelector('.sun-icon');
            if (theme === 'dark') {
                moonIcon.style.display = 'none';
                sunIcon.style.display = 'block';
            } else {
                moonIcon.style.display = 'block';
                sunIcon.style.display = 'none';
            }
        }

        // Initialize theme from saved preference
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        });

        // Add change event listener for objection textarea
        document.body.addEventListener('change', (event) => {
            if (event.target.id === 'focus-objection-textarea') {
                const caseData = appData.cases.find(c => c.caseId === currentCaseId);
                if (!caseData) return;

                const letterData = caseData.requestLetters.find(l => l.id === currentLetterId);
                if (!letterData) return;

                const currentRequest = letterData.requests[currentFocusIndex];
                if (currentRequest) {
                    currentRequest.objection = event.target.value;
                }
            }
        });

        // Add input event listener for reply editor
        document.body.addEventListener('input', (event) => {
            if (event.target.id === 'focus-reply-editor') {
                const caseData = appData.cases.find(c => c.caseId === currentCaseId);
                if (!caseData) return;

                const letterData = caseData.requestLetters.find(l => l.id === currentLetterId);
                if (!letterData) return;

                const currentRequest = letterData.requests[currentFocusIndex];
                if (currentRequest) {
                    currentRequest.reply = event.target.innerHTML;
                }
            }
        });

        // --- DATA PERSISTENCE ---
        async function saveCurrentCase() {
            const caseData = appData.cases.find(c => c.caseId === currentCaseId);
            if (caseData) {
                try {
                    await window.electronAPI.saveCase(caseData);
                    console.log('Case data saved successfully');
                } catch (error) {
                    console.error('Error saving case data:', error);
                }
            }
        }

        // Auto-save when important changes occur
        async function autoSave() {
            if (currentCaseId) {
                await saveCurrentCase();
            }
        }

        // Load all cases on startup
        async function loadAllCasesData() {
            try {
                const cases = await window.electronAPI.loadAllCases();
                if (cases && cases.length > 0) {
                    appData.cases = cases;
                    renderCasesDashboard();
                }
            } catch (error) {
                console.error('Error loading cases:', error);
            }
        }

        // Add autosave functionality
        // Using global AUTOSAVE_DELAY and autoSaveTimeout

        function showAutosaveIndicator() {
            const indicator = document.querySelector('.autosave-indicator');
            indicator.classList.add('visible');
            
            // Hide the indicator after 2 seconds
            setTimeout(() => {
                indicator.classList.remove('visible');
            }, 2000);
        }

        async function handleReplyChange(event) {
            if (event.target.id === 'focus-reply-editor') {
                // Clear any existing timeout
                clearTimeout(autosaveTimeout);
                
                // Set new timeout
                autosaveTimeout = setTimeout(async () => {
                    const caseData = appData.cases.find(c => c.caseId === currentCaseId);
                    if (!caseData) return;

                    const letterData = caseData.requestLetters.find(l => l.id === currentLetterId);
                    if (!letterData) return;

                    const currentRequest = letterData.requests[currentFocusIndex];
                    if (currentRequest) {
                        currentRequest.reply = event.target.innerHTML;
                        await autoSave();
                        showAutosaveIndicator();
                    }
                }, AUTOSAVE_DELAY);
            }
        }

        // Update the setupAutoSave function
        function setupAutoSave() {
            // Save after objection changes
            document.body.addEventListener('change', async (event) => {
                if (event.target.id === 'focus-objection-textarea') {
                    await autoSave();
                }
            });

            // Save after reply changes
            document.body.addEventListener('input', handleReplyChange);

            // Save when navigating away from focus view
            document.body.addEventListener('click', async (event) => {
                if (event.target.matches('[data-action="back-to-list"]')) {
                    await autoSave();
                }
            });
        }

        // Initialize app with data persistence
        document.addEventListener('DOMContentLoaded', async () => {
            await loadAllCasesData();
            setupAutoSave();
            
        });

        // Modal functions for case and letter management
        function showAddCaseModal() {
            document.getElementById('add-case-modal').classList.add('visible');
            document.getElementById('case-name-input').focus();
        }

        function hideAddCaseModal() {
            document.getElementById('add-case-modal').classList.remove('visible');
            document.getElementById('case-name-input').value = '';
        }

        function showEditCaseModal(caseId) {
            currentEditingCaseId = caseId;
            const caseData = appData.cases.find(c => c.caseId === caseId);
            if (caseData) {
                document.getElementById('edit-case-name-input').value = caseData.caseName;
                document.getElementById('edit-case-modal').classList.add('visible');
                document.getElementById('edit-case-name-input').focus();
            }
        }

        function hideEditCaseModal() {
            document.getElementById('edit-case-modal').classList.remove('visible');
            document.getElementById('edit-case-name-input').value = '';
            currentEditingCaseId = null;
        }

        async function createNewCase() {
            const caseName = document.getElementById('case-name-input').value.trim();
            if (!caseName) return;

            const caseId = caseName.toLowerCase().replace(/[^a-z0-9]+/g, '-');
            const newCase = {
                caseId,
                caseName,
                requestLetters: []
            };

            appData.cases.push(newCase);
            await autoSave();
            renderCasesDashboard();
            hideAddCaseModal();
        }

        async function saveEditedCase() {
            if (!currentEditingCaseId) return;

            const newName = document.getElementById('edit-case-name-input').value.trim();
            if (!newName) return;

            const caseData = appData.cases.find(c => c.caseId === currentEditingCaseId);
            if (caseData) {
                caseData.caseName = newName;
                await autoSave();
                renderCasesDashboard();
                hideEditCaseModal();
            }
        }

        function showEditLetterModal(letterId) {
            currentEditingLetterId = letterId;
            const letterData = appData.cases.find(c => c.caseId === currentCaseId)
                                    ?.requestLetters.find(l => l.id === letterId);
            if (letterData) {
                document.getElementById('edit-letter-name-input').value = letterData.description;
                document.getElementById('edit-letter-modal').classList.add('visible');
                document.getElementById('edit-letter-name-input').focus();
            }
        }

        function hideEditLetterModal() {
            document.getElementById('edit-letter-modal').classList.remove('visible');
            document.getElementById('edit-letter-name-input').value = '';
            currentEditingLetterId = null;
        }

        async function saveEditedLetter() {
            if (!currentEditingLetterId) return;

            const newDescription = document.getElementById('edit-letter-name-input').value.trim();
            if (!newDescription) return;

            const caseData = appData.cases.find(c => c.caseId === currentCaseId);
            if (caseData) {
                const letterData = caseData.requestLetters.find(l => l.id === currentEditingLetterId);
                if (letterData) {
                    letterData.description = newDescription;
                    await autoSave();
                    renderRequestLettersView();
                    hideEditLetterModal();
                }
            }
        }

        function showResponseLetterModal() {
            document.getElementById('response-letter-modal').classList.add('visible');
            generateResponseLetter();
        }

        function hideResponseLetterModal() {
            document.getElementById('response-letter-modal').classList.remove('visible');
        }

        async function generateResponseLetter() {
            const caseData = appData.cases.find(c => c.caseId === currentCaseId);
            if (!caseData) return;

            const letterData = caseData.requestLetters.find(l => l.id === currentLetterId);
            if (!letterData) return;

            const editor = document.getElementById('letter-editor');
            editor.innerHTML = '<div class="loading-spinner"></div> Generating letter...';

            try {
                const letterContent = await window.electronAPI.generateResponseLetter({
                    caseName: caseData.caseName,
                    letterDescription: letterData.description,
                    requests: letterData.requests
                });

                if (letterContent.success) {
                    editor.innerHTML = letterContent.html;
                } else {
                    editor.innerHTML = `<div style="color: red;">Error generating letter: ${letterContent.error}</div>`;
                }
            } catch (error) {
                editor.innerHTML = `<div style="color: red;">Error: ${error.message}</div>`;
            }
        }

        async function saveResponseLetter() {
            try {
                const editor = document.getElementById('letter-editor');
                const content = editor.innerHTML;
                
                const caseData = appData.cases.find(c => c.caseId === currentCaseId);
                if (!caseData) return;

                const letterData = caseData.requestLetters.find(l => l.id === currentLetterId);
                if (!letterData) return;

                // Save the letter content to the letter data
                letterData.responseLetter = content;
                await autoSave();

                // Show success message
                const autosaveIndicator = document.querySelector('.autosave-indicator');
                autosaveIndicator.classList.add('visible');
                setTimeout(() => {
                    autosaveIndicator.classList.remove('visible');
                }, 2000);
            } catch (error) {
                console.error('Error saving response letter:', error);
                alert('Error saving the letter. Please try again.');
            }
        }

        async function exportResponseLetter(format) {
            try {
                const editor = document.getElementById('letter-editor');
                const content = editor.innerHTML;
                
                const result = await window.electronAPI.exportLetter({
                    content,
                    format,
                    fileName: `Response_Letter_${new Date().toISOString().split('T')[0]}`
                });

                if (result.success) {
                    // Show success message
                    alert(`Letter exported successfully as ${format.toUpperCase()}`);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error exporting letter:', error);
                alert(`Error exporting letter as ${format.toUpperCase()}. Please try again.`);
            }
        }

        // Add to your existing JavaScript

        let currentZoomLevel = 100;

        function showLetterEditor() {
            document.body.className = 'letter-editor-active';
            updateLetterStats();
            updateEditorHeader();
        }

        function updateEditorHeader() {
            const caseData = appData.cases.find(c => c.caseId === currentCaseId);
            if (!caseData) return;

            const letterData = caseData.requestLetters.find(l => l.id === currentLetterId);
            if (!letterData) return;

            document.getElementById('letter-editor-header').textContent = caseData.caseName;
            document.getElementById('letter-editor-subtitle').textContent = letterData.description;
        }

        function updateLetterStats() {
            const caseData = appData.cases.find(c => c.caseId === currentCaseId);
            if (!caseData) return;

            const letterData = caseData.requestLetters.find(l => l.id === currentLetterId);
            if (!letterData) return;

            const totalRequests = letterData.requests.length;
            const withObjections = letterData.requests.filter(r => r.objection && r.objection.trim()).length;
            const withResponses = letterData.requests.filter(r => r.reply && r.reply.trim()).length;
            const pending = withObjections - withResponses;

            document.getElementById('stat-total-requests').textContent = totalRequests;
            document.getElementById('stat-with-objections').textContent = withObjections;
            document.getElementById('stat-with-responses').textContent = withResponses;
            document.getElementById('stat-pending').textContent = pending;
        }

        function updateGenerationProgress(stage, status, progress) {
            const progressSection = document.querySelector('.generation-progress');
            progressSection.style.display = 'block';

            // Update stages
            document.querySelectorAll('.progress-stage').forEach(stageEl => {
                const stageName = stageEl.dataset.stage;
                stageEl.classList.remove('active', 'completed');
                
                if (stageName === stage) {
                    stageEl.classList.add('active');
                } else if (getStageIndex(stageName) < getStageIndex(stage)) {
                    stageEl.classList.add('completed');
                }
            });

            // Update progress bar
            const progressBar = progressSection.querySelector('.progress-bar');
            progressBar.style.width = `${progress}%`;

            // Update status text
            const statusEl = progressSection.querySelector('.progress-status');
            statusEl.textContent = status;
        }

        function getStageIndex(stage) {
            const stages = ['setup', 'header', 'body', 'conclusion', 'formatting'];
            return stages.indexOf(stage);
        }

        async function generateResponseLetter() {
            const caseData = appData.cases.find(c => c.caseId === currentCaseId);
            if (!caseData) return;

            const letterData = caseData.requestLetters.find(l => l.id === currentLetterId);
            if (!letterData) return;

            const generateButton = document.querySelector('[data-action="generate-letter"]');
            generateButton.disabled = true;

            try {
                // Reset letter sections
                letterSections = {
                    header: '',
                    requests: [],
                    conclusion: ''
                };

                // Stage 1: Setup
                updateGenerationProgress('setup', 'Preparing document generation...', 10);
                await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate setup time

                // Stage 2: Header
                const headerResult = await window.electronAPI.generateLetterSection({
                    type: 'header',
                    caseName: caseData.caseName,
                    letterDescription: letterData.description
                });

                // Stage 3: Body (Process each request)
                const totalRequests = letterData.requests.length;
                
                for (let i = 0; i < totalRequests; i++) {
                    const request = letterData.requests[i];
                    const progress = 40 + (40 * (i / totalRequests));
                    
                    const requestResult = await window.electronAPI.generateLetterSection({
                        type: 'request',
                        requestNumber: i + 1,
                        requestText: request.text,
                        objectionText: request.objection,
                        replyText: request.reply
                    });
                }

                // Stage 4: Conclusion
                const conclusionResult = await window.electronAPI.generateLetterSection({
                    type: 'conclusion'
                });

                // Stage 5: Final Formatting
                updateGenerationProgress('formatting', 'Applying final formatting...', 95);
                
                // Complete
                updateGenerationProgress('formatting', 'Letter generation complete!', 100);
                setTimeout(() => {
                    document.querySelector('.generation-progress').style.display = 'none';
                }, 2000);

            } catch (error) {
                console.error('Error generating letter:', error);
                document.querySelector('.progress-status').textContent = `Error: ${error.message}`;
                document.querySelector('.progress-status').style.color = 'var(--status-error)';
            } finally {
                generateButton.disabled = false;
            }
        }

        function zoomIn() {
            if (currentZoomLevel < 200) {
                currentZoomLevel += 25;
                updateZoom();
            }
        }

        function zoomOut() {
            if (currentZoomLevel > 50) {
                currentZoomLevel -= 25;
                updateZoom();
            }
        }

        function updateZoom() {
            const content = document.getElementById('letter-preview-content');
            content.style.transform = `scale(${currentZoomLevel / 100})`;
            document.getElementById('zoom-level').textContent = `${currentZoomLevel}%`;
        }

        // Update the click event listener
        document.body.addEventListener('click', (event) => {
            const target = event.target;
            const action = target.dataset.action;

            if (action === 'build-letter') {
                showLetterEditor();
            } else if (action === 'back-to-disputes') {
                showDisputeListView(currentLetterId);
            } else if (action === 'generate-letter') {
                generateResponseLetter();
            }
            // ... existing click handlers ...
        });

        // Add to your JavaScript after other functions

        let letterSections = {
            header: '',
            requests: [],
            conclusion: ''
        };

        function updatePreview() {
            const content = document.getElementById('letter-preview-content');
            content.innerHTML = `
                ${letterSections.header}
                ${letterSections.requests.join('\n')}
                ${letterSections.conclusion}
            `;
        }

        // Set up letter progress listener
        window.electronAPI.onLetterProgress((progress) => {
            switch (progress.type) {
                case 'section-start':
                    // Update progress UI
                    updateGenerationProgress(progress.section, progress.message, getProgressPercentage(progress.section));
                    break;

                case 'section-complete':
                    // Store the completed section
                    if (progress.section === 'header') {
                        letterSections.header = progress.html;
                    } else if (progress.section === 'request') {
                        letterSections.requests.push(progress.html);
                    } else if (progress.section === 'conclusion') {
                        letterSections.conclusion = progress.html;
                    }
                    
                    // Update the preview immediately
                    updatePreview();
                    break;

                case 'error':
                    // Show error in the preview area
                    const errorHtml = `
                        <div style="color: var(--status-error); padding: 20px;">
                            <h3>Error in ${progress.section}</h3>
                            <p>${progress.error}</p>
                        </div>
                    `;
                    
                    if (progress.section === 'header') {
                        letterSections.header = errorHtml;
                    } else if (progress.section === 'request') {
                        letterSections.requests.push(errorHtml);
                    } else if (progress.section === 'conclusion') {
                        letterSections.conclusion = errorHtml;
                    }
                    
                    updatePreview();
                    break;
            }
        });

        function getProgressPercentage(section) {
            switch (section) {
                case 'setup': return 10;
                case 'header': return 25;
                case 'body': return 40;
                case 'conclusion': return 85;
                case 'formatting': return 95;
                default: return 0;
            }
        }

        async function generateResponseLetter() {
            const caseData = appData.cases.find(c => c.caseId === currentCaseId);
            if (!caseData) return;

            const letterData = caseData.requestLetters.find(l => l.id === currentLetterId);
            if (!letterData) return;

            const generateButton = document.querySelector('[data-action="generate-letter"]');
            generateButton.disabled = true;

            try {
                // Reset letter sections
                letterSections = {
                    header: '',
                    requests: [],
                    conclusion: ''
                };

                // Stage 1: Setup
                updateGenerationProgress('setup', 'Preparing document generation...', 10);
                await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate setup time

                // Stage 2: Header
                const headerResult = await window.electronAPI.generateLetterSection({
                    type: 'header',
                    caseName: caseData.caseName,
                    letterDescription: letterData.description
                });

                // Stage 3: Body (Process each request)
                const totalRequests = letterData.requests.length;
                
                for (let i = 0; i < totalRequests; i++) {
                    const request = letterData.requests[i];
                    const progress = 40 + (40 * (i / totalRequests));
                    
                    const requestResult = await window.electronAPI.generateLetterSection({
                        type: 'request',
                        requestNumber: i + 1,
                        requestText: request.text,
                        objectionText: request.objection,
                        replyText: request.reply
                    });
                }

                // Stage 4: Conclusion
                const conclusionResult = await window.electronAPI.generateLetterSection({
                    type: 'conclusion'
                });

                // Stage 5: Final Formatting
                updateGenerationProgress('formatting', 'Applying final formatting...', 95);
                
                // Complete
                updateGenerationProgress('formatting', 'Letter generation complete!', 100);
                setTimeout(() => {
                    document.querySelector('.generation-progress').style.display = 'none';
                }, 2000);

            } catch (error) {
                console.error('Error generating letter:', error);
                document.querySelector('.progress-status').textContent = `Error: ${error.message}`;
                document.querySelector('.progress-status').style.color = 'var(--status-error)';
            } finally {
                generateButton.disabled = false;
            }
        }

        // Add to your JavaScript after the initial data structure

        // Version history tracking
        let letterVersions = {};
        // Using global AUTOSAVE_DELAY and autoSaveTimeout

        // Autosave function for letter drafts
        async function autosaveLetter() {
            const caseData = appData.cases.find(c => c.caseId === currentCaseId);
            if (!caseData) return;

            const letterData = caseData.requestLetters.find(l => l.id === currentLetterId);
            if (!letterData) return;

            // Create a version ID based on timestamp
            const versionId = Date.now();
            const content = document.getElementById('letter-preview-content').innerHTML;

            // Initialize version history for this letter if it doesn't exist
            if (!letterVersions[letterData.id]) {
                letterVersions[letterData.id] = [];
            }

            // Add new version
            letterVersions[letterData.id].push({
                id: versionId,
                timestamp: new Date().toISOString(),
                content: content,
                sections: { ...letterSections } // Store current sections state
            });

            // Keep only last 10 versions
            if (letterVersions[letterData.id].length > 10) {
                letterVersions[letterData.id].shift();
            }

            // Show autosave indicator
            const indicator = document.querySelector('.autosave-indicator');
            indicator.classList.add('visible');
            setTimeout(() => {
                indicator.classList.remove('visible');
            }, 2000);

            // Save to storage
            await window.electronAPI.saveCase({
                ...caseData,
                letterVersions: letterVersions[letterData.id]
            });
        }

        // Add version history modal HTML after your other modals
        const versionHistoryModal = `
            <div class="modal-overlay" id="version-history-modal">
                <div class="modal">
                    <div class="modal-header">
                        <h3>Version History</h3>
                        <button class="modal-close" onclick="hideVersionHistoryModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="version-list" id="version-list">
                            <!-- Versions will be populated here -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="hideVersionHistoryModal()">Close</button>
                    </div>
                </div>
            </div>
        `;

        // Add version history button to the preview toolbar
        document.querySelector('.preview-toolbar').innerHTML += `
            <button class="btn btn-secondary" onclick="showVersionHistoryModal()">
                <svg width="16" height="16" viewBox="0 0 16 16">
                    <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z" fill="currentColor"/>
                    <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z" fill="currentColor"/>
                </svg>
                Version History
            </button>
        `;

        // Add version history modal functions
        function showVersionHistoryModal() {
            const modal = document.getElementById('version-history-modal');
            const versionList = document.getElementById('version-list');
            const letterData = appData.cases.find(c => c.caseId === currentCaseId)
                ?.requestLetters.find(l => l.id === currentLetterId);
            
            if (!letterData || !letterVersions[letterData.id]) {
                versionList.innerHTML = '<p>No previous versions available.</p>';
            } else {
                versionList.innerHTML = letterVersions[letterData.id]
                    .sort((a, b) => b.id - a.id)
                    .map(version => `
                        <div class="version-item">
                            <div class="version-info">
                                <span class="version-date">${new Date(version.timestamp).toLocaleString()}</span>
                            </div>
                            <div class="version-actions">
                                <button class="btn btn-secondary" onclick="previewVersion('${version.id}')">Preview</button>
                                <button class="btn btn-primary" onclick="restoreVersion('${version.id}')">Restore</button>
                            </div>
                        </div>
                    `).join('');
            }
            
            modal.classList.add('visible');
        }

        function hideVersionHistoryModal() {
            document.getElementById('version-history-modal').classList.remove('visible');
        }

        function previewVersion(versionId) {
            const letterData = appData.cases.find(c => c.caseId === currentCaseId)
                ?.requestLetters.find(l => l.id === currentLetterId);
            
            if (!letterData || !letterVersions[letterData.id]) return;
            
            const version = letterVersions[letterData.id].find(v => v.id === parseInt(versionId));
            if (!version) return;
            
            // Show preview in a new modal
            const previewModal = document.createElement('div');
            previewModal.className = 'modal-overlay';
            previewModal.innerHTML = `
                <div class="modal letter-modal">
                    <div class="modal-header">
                        <h3>Version from ${new Date(version.timestamp).toLocaleString()}</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="letter-preview-container">
                            <div class="letter-preview-content">
                                ${version.content}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(previewModal);
            previewModal.classList.add('visible');
        }

        function restoreVersion(versionId) {
            const letterData = appData.cases.find(c => c.caseId === currentCaseId)
                ?.requestLetters.find(l => l.id === currentLetterId);
            
            if (!letterData || !letterVersions[letterData.id]) return;
            
            const version = letterVersions[letterData.id].find(v => v.id === parseInt(versionId));
            if (!version) return;
            
            // Restore the content and sections
            letterSections = { ...version.sections };
            updatePreview();
            
            // Hide the version history modal
            hideVersionHistoryModal();
            
            // Show success message
            const indicator = document.querySelector('.autosave-indicator');
            indicator.querySelector('.text').textContent = 'Version restored';
            indicator.classList.add('visible');
            setTimeout(() => {
                indicator.classList.remove('visible');
                indicator.querySelector('.text').textContent = 'Changes saved';
            }, 2000);
        }

        // Add CSS for version history
        const versionHistoryStyles = `
            .version-list {
                max-height: 400px;
                overflow-y: auto;
            }

            .version-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px;
                border-bottom: 1px solid var(--border-light);
            }

            .version-item:last-child {
                border-bottom: none;
            }

            .version-info {
                flex-grow: 1;
            }

            .version-date {
                font-size: 0.9rem;
                color: var(--text-secondary);
            }

            .version-actions {
                display: flex;
                gap: 8px;
            }

            .letter-preview-container {
                background: white;
                padding: 40px;
                margin: 20px;
                box-shadow: var(--shadow-md);
            }
        `;

        // Add the styles to the existing style section
        document.querySelector('style').textContent += versionHistoryStyles;

        // Modify the existing generateResponseLetter function to include autosave
        // Using global AUTOSAVE_DELAY and autoSaveTimeout

        // Add autosave trigger to the letter progress listener
        window.electronAPI.onLetterProgress((progress) => {
            // ... existing progress handling code ...

            // Clear any existing autosave timeout
            clearTimeout(autoSaveTimeout);
            
            // Set new timeout for autosave
            autoSaveTimeout = setTimeout(autosaveLetter, AUTOSAVE_DELAY);
        });
    </script>

    <!-- Add Case Modal -->
    <div class="modal-overlay" id="add-case-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Add New Case</h3>
                <button class="modal-close" onclick="hideAddCaseModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="case-name-input">Case Name</label>
                    <input type="text" id="case-name-input" placeholder="Enter case name...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideAddCaseModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createNewCase()">Create Case</button>
            </div>
        </div>
    </div>

    <!-- Edit Case Modal -->
    <div class="modal-overlay" id="edit-case-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Edit Case Name</h3>
                <button class="modal-close" onclick="hideEditCaseModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="edit-case-name-input">Case Name</label>
                    <input type="text" id="edit-case-name-input">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideEditCaseModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveEditedCase()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Add the edit letter modal to the HTML -->
    <div class="modal-overlay" id="edit-letter-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Edit Request Letter Name</h3>
                <button class="modal-close" onclick="hideEditLetterModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="edit-letter-name-input">Request Letter Name</label>
                    <input type="text" id="edit-letter-name-input">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideEditLetterModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveEditedLetter()">Save Changes</button>
            </div>
        </div>
    </div>
</body>
</html>