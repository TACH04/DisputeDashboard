<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discovery Dispute Management Dashboard</title>
    <style>
        :root {
            --primary-blue: #0d6efd;
            --secondary-gray: #6c757d;
            --action-green: #198754;
            --background-light: #f8f9fa;
            --text-dark: #212529;
            --border-color: #dee2e6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background-light);
            color: var(--text-dark);
            line-height: 1.5;
            height: 100vh;
            overflow: hidden; /* Prevent body scrollbars, we'll handle scrolling inside views */
        }
        
        /* --- START: CORRECTED VIEW-SWITCHING LOGIC --- */
        /* By default, all top-level views are hidden. */
        #cases-dashboard-view, #dispute-list-view, #focus-view, #request-letters-view { 
            display: none; 
            width: 100%;
            height: 100vh;
            overflow-y: auto; /* Allow scrolling within each view if needed */
        }
        
        /* The body class determines which ONE view is shown. */
        body.cases-view-active #cases-dashboard-view { display: block; }
        body.dispute-list-active #dispute-list-view { display: block; }
        body.focus-mode-active #focus-view { display: flex; flex-direction: column; }
        body.request-letters-active #request-letters-view { display: block; }
        /* --- END: CORRECTED VIEW-SWITCHING LOGIC --- */

        /* --- SHARED STYLES --- */
        .container { max-width: 95%; margin: 0 auto; padding: 20px; }
        header { padding: 20px; margin-bottom: 20px; }
        header h1 { font-size: 1.8rem; }
        header h2 { font-size: 1.1rem; font-weight: 400; color: var(--secondary-gray); }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background-color: var(--primary-blue); color: white; }
        .btn-primary:hover { background-color: #0b5ed7; }
        .btn-secondary { background-color: var(--secondary-gray); color: white; }
        .btn-secondary:hover { background-color: #5c636a; }
        .btn-action { background-color: var(--action-green); color: white; }
        .btn-action:hover { background-color: #157347; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* --- PROGRESS INDICATORS --- */
        .progress-section {
            margin: 20px 0;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease-in-out;
        }
        .progress-section.visible {
            opacity: 1;
            max-height: 100px;
            margin: 20px 0;
        }
        .status-bar {
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 6px;
            text-align: center;
            font-weight: 500;
            background-color: #e9ecef;
            color: var(--text-dark);
        }
        .status-bar.status-processing { background-color: #e9ecef; color: var(--text-dark); }
        .status-bar.status-success { background-color: var(--action-green); color: white; }
        .status-bar.status-error { background-color: #dc3545; color: white; }
        .progress-container {
            width: 100%;
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: var(--primary-blue);
            transition: width 0.4s ease;
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top-color: var(--primary-blue);
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- ACTION BAR --- */
        .action-bar {
            display: flex;
            gap: 12px;
            margin: 20px 0;
            flex-wrap: wrap;
            align-items: center;
            background-color: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        /* --- CASES DASHBOARD VIEW --- */
        #cases-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .case-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .case-card:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.12); }
        .case-card h3 { font-size: 1.2rem; margin-bottom: 8px; }
        .case-card p { color: var(--secondary-gray); }

        /* --- DISPUTE LIST VIEW --- */
        .table-container { background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow-x: auto; }
        .dispute-table { width: 100%; border-collapse: collapse; min-width: 1200px; }
        .dispute-table th, .dispute-table td { padding: 16px; border-bottom: 1px solid var(--border-color); vertical-align: top; text-align: left; }
        .dispute-table thead th { background-color: var(--background-light); font-weight: 600; }
        .dispute-table tbody tr { cursor: pointer; }
        .dispute-table tbody tr:hover { background-color: #e9ecef; }
        .col-number { width: 5%; } .col-request { width: 35%; } .col-objection { width: 60%; }

        /* --- START: RIGID FOCUS VIEW LAYOUT --- */
        .focus-container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            
            flex-grow: 1; /* Make this fill the parent #focus-view */
            min-height: 0; 
            
            /* Use a rigid grid for the internal structure */
            display: grid;
            grid-template-rows: auto 120px 1fr; /* Header | Pinned-Height Request | Expanding Content */
            gap: 20px;
        }

        .focus-header {
            display: grid;
            grid-template-columns: auto 1fr auto; 
            align-items: center;
            gap: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .focus-header h3 {
            text-align: center;
            font-size: 1.4rem;
        }

        .focus-request {
            overflow-y: auto; /* Scroll internally if content is too long */
            background-color: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
        }

        .focus-content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            min-height: 0; 
        }
        
        .focus-col {
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .focus-col h4 {
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .text-pane {
            width: 100%;
            flex-grow: 1;
            overflow-y: auto;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: white;
            font-family: Georgia, 'Times New Roman', Times, serif;
            font-size: 16px;
            line-height: 1.6;
        }
        /* --- END: RIGID FOCUS VIEW LAYOUT --- */
    </style>
</head>
<body>

    <!-- VIEW 1: CASES DASHBOARD -->
    <div id="cases-dashboard-view">
        <div class="container">
            <header>
                <h1>All Cases</h1>
                <h2>Select a case to view its discovery disputes.</h2>
            </header>
            <div id="cases-grid"></div>
        </div>
    </div>

    <!-- VIEW 2: REQUEST LETTERS MENU -->
    <div id="request-letters-view">
        <div class="container">
            <header>
                <h1 id="request-letters-header">Case Name</h1>
                <h2>Select a request letter to analyze.</h2>
            </header>
            <div class="action-bar">
                <button class="btn btn-secondary" data-action="back-to-cases">‚Üê Back to All Cases</button>
                <button class="btn btn-primary" data-action="upload-request">Upload New Request Letter</button>
            </div>
            <div class="progress-section" id="request-progress-section">
                <div id="request-status-bar" class="status-bar"></div>
                <div id="request-progress-container" class="progress-container">
                    <div id="request-progress-bar" class="progress-bar"></div>
                </div>
            </div>
            <div class="table-container">
                <table class="dispute-table">
                    <thead>
                        <tr>
                            <th style="width: 20%">Date Added</th>
                            <th style="width: 50%">Description</th>
                            <th style="width: 15%">Requests</th>
                            <th style="width: 15%">Status</th>
                        </tr>
                    </thead>
                    <tbody id="request-letters-table"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- VIEW 3: DISPUTE LIST (FOR A SINGLE REQUEST LETTER) -->
    <div id="dispute-list-view">
        <div class="container">
            <header>
                <h1 id="case-name-header">Case Name</h1>
                <h2 id="case-subtitle">Manage discovery disputes for this case.</h2>
            </header>
            <div class="action-bar">
                <button class="btn btn-secondary" data-action="back-to-letters">‚Üê Back to Request Letters</button>
                <button class="btn btn-primary" data-action="upload">Upload Opponent's Response</button>
                <button class="btn btn-action" data-action="generate-all">Generate All Pending Replies</button>
            </div>
            <div class="progress-section" id="dispute-progress-section">
                <div id="dispute-status-bar" class="status-bar"></div>
                <div id="dispute-progress-container" class="progress-container">
                    <div id="dispute-progress-bar" class="progress-bar"></div>
                </div>
            </div>
            <div class="table-container">
                <table class="dispute-table">
                    <thead>
                        <tr>
                            <th class="col-number">#</th>
                            <th class="col-request">Your Request (Summary)</th>
                            <th class="col-objection">Opponent's Objection</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- VIEW 4: FOCUS VIEW (FOR A SINGLE DISPUTE) -->
    <div id="focus-view">
        <div class="focus-container">
            <div class="focus-header">
                <button data-action="back-to-list" class="btn btn-secondary">‚Üê Back to Dispute List</button>
                <h3 id="focus-title">Request X of Y</h3>
                <div>
                    <button data-action="focus-prev" class="btn btn-primary">‚Äπ</button>
                    <button data-action="focus-next" class="btn btn-primary">‚Ä∫</button>
                </div>
            </div>
            <div id="focus-request-text" class="focus-request"></div>
            <div id="focus-content-grid" class="focus-content-grid">
                <!-- Content is dynamically built by renderFocusView() -->
            </div>
        </div>
    </div>
    <script type="text/javascript">
        // --- DATA STORE ---
        const initialData = {
            cases: [
                {
                    caseId: 'gardner-navajo',
                    caseName: "Gardner v. Navajo County, et al.",
                    requestLetters: [
                        {
                            id: 'rog-set1',
                            dateAdded: '2024-03-15',
                            description: 'First Set of Interrogatories to Defendant Wexford',
                            requests: [
                                {
                                    id: 1,
                                    text: "For each employee or agent of Wexford... affirm or deny whether that person will testify about any spoken statements allegedly made by Amanda Gardner...",
                                    objection: null,
                                    reply: null
                                },
                                {
                                    id: 2,
                                    text: "Identify all spoken or written statements made by each employee or agent of Wexford... regarding the treatment of Amanda Gardner.",
                                    objection: "Objection. Plaintiff's Interrogatory contains multiple subparts, is not limited in time or scope, and requests information...",
                                    reply: null
                                }
                            ]
                        }
                    ]
                },
                {
                    caseId: 'acme-vs-wile',
                    caseName: "Acme Corp. v. Wile E. Coyote",
                    requestLetters: [
                        {
                            id: 'rog-set1',
                            dateAdded: '2024-03-10',
                            description: 'First Set of Interrogatories',
                            requests: [
                                {
                                    id: 1,
                                    text: "Identify all rocket-powered devices purchased...",
                                    objection: "Overly broad.",
                                    reply: null
                                },
                                {
                                    id: 2,
                                    text: "Describe the intended use of the 'Giant Rubber Band'...",
                                    objection: null,
                                    reply: null
                                }
                            ]
                        }
                    ]
                }
            ]
        };
        
        let appData = JSON.parse(JSON.stringify(initialData));
        
        // --- STATE MANAGEMENT ---
        let currentCaseId = null;
        let currentLetterId = null;
        let currentFocusIndex = -1;

        // --- VIEW SWITCHING & RENDERING ---
        function showCasesDashboard() {
            document.body.className = 'cases-view-active';
            renderCasesDashboard();
        }

        function showRequestLettersView(caseId) {
            currentCaseId = caseId;
            currentLetterId = null;
            document.body.className = 'request-letters-active';
            renderRequestLettersView();
        }

        function showDisputeListView(letterId) {
            currentLetterId = letterId;
            document.body.className = 'dispute-list-active';
            renderDisputeListView();
        }

        function showFocusView(requestIndex) {
            currentFocusIndex = requestIndex;
            document.body.className = 'focus-mode-active';
            renderFocusView();
        }
        
        function renderCasesDashboard() {
            const grid = document.getElementById('cases-grid');
            grid.innerHTML = '';
            appData.cases.forEach(c => {
                const allRequests = c.requestLetters.reduce((acc, letter) => acc + letter.requests.length, 0);
                const unresolvedCount = c.requestLetters.reduce((acc, letter) => {
                    return acc + letter.requests.filter(r => r.objection && !r.reply).length;
                }, 0);
                
                const card = document.createElement('div');
                card.className = 'case-card';
                card.dataset.caseId = c.caseId;
                card.innerHTML = `
                    <h3>${c.caseName}</h3>
                    <p>${unresolvedCount} of ${allRequests} disputes need a reply.</p>
                    <p style="color: var(--secondary-gray); font-size: 0.9em; margin-top: 8px;">
                        ${c.requestLetters.length} Request Letter${c.requestLetters.length !== 1 ? 's' : ''}
                    </p>
                `;
                grid.appendChild(card);
            });
        }

        // --- STATUS UPDATING FUNCTIONS ---
        function updateRequestStatus(request, tableRow) {
            const hasObjection = request.objection && request.objection.trim() !== '';
            const hasReply = request.reply && request.reply.trim() !== '';
            
            let statusIcon = '';
            let statusColor = '';
            
            if (hasObjection) {
                if (hasReply) {
                    statusIcon = '‚úî';
                    statusColor = 'var(--action-green)';
                } else {
                    statusIcon = '!';
                    statusColor = '#ffc107';
                }
            } else {
                statusIcon = '‚Äî';
                statusColor = '#dc3545';
            }

            const statusSpan = tableRow.querySelector('.col-number span');
            if (statusSpan) {
                statusSpan.style.color = statusColor;
                statusSpan.textContent = statusIcon;
            }
        }

        function updateLetterStatus(letterData, letterRow) {
            const unresolvedCount = letterData.requests.filter(r => r.objection && !r.reply).length;
            const totalRequests = letterData.requests.length;
            const objectionCount = letterData.requests.filter(r => r.objection).length;
            
            let status = '';
            let statusColor = '';
            
            if (objectionCount === 0) {
                status = 'Awaiting Responses';
                statusColor = 'var(--secondary-gray)';
            } else if (unresolvedCount === 0) {
                status = 'All Replied';
                statusColor = 'var(--action-green)';
            } else {
                status = `${unresolvedCount} Need Reply`;
                statusColor = '#ffc107';
            }

            const statusCell = letterRow.querySelector('td:last-child span');
            if (statusCell) {
                statusCell.style.color = statusColor;
                statusCell.textContent = status;
            }
        }

        function renderRequestLettersView() {
            const caseData = appData.cases.find(c => c.caseId === currentCaseId);
            if (!caseData) return showCasesDashboard();

            document.getElementById('request-letters-header').textContent = caseData.caseName;
            const tableBody = document.getElementById('request-letters-table');
            tableBody.innerHTML = '';

            caseData.requestLetters.forEach(letter => {
                const row = document.createElement('tr');
                row.dataset.letterId = letter.id;
                
                const totalRequests = letter.requests.length;
                
                row.innerHTML = `
                    <td>${letter.dateAdded}</td>
                    <td>${letter.description}</td>
                    <td>${totalRequests} Request${totalRequests !== 1 ? 's' : ''}</td>
                    <td><span></span></td>
                `;
                tableBody.appendChild(row);
                
                // Update the status after creating the row
                updateLetterStatus(letter, row);
            });
        }

        function renderDisputeListView() {
            const caseData = appData.cases.find(c => c.caseId === currentCaseId);
            if (!caseData) return showCasesDashboard();

            const letterData = caseData.requestLetters.find(l => l.id === currentLetterId);
            if (!letterData) return showRequestLettersView(currentCaseId);

            document.getElementById('case-name-header').textContent = `${caseData.caseName} - ${letterData.description}`;
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';

            letterData.requests.forEach((request, index) => {
                const row = document.createElement('tr');
                row.dataset.index = index;
                
                const objectionText = request.objection && request.objection.trim() !== ''
                    ? (request.objection || '').substring(0, 100) + '...' 
                    : '<i>No objection provided.</i>';

                row.innerHTML = `
                    <td class="col-number">
                        <span style="font-weight: bold; display: inline-block; width: 1.5em; text-align: center;"></span>
                        ${request.id}
                    </td>
                    <td class="col-request">${(request.text || '').substring(0, 80)}...</td>
                    <td class="col-objection">${objectionText}</td>
                `;
                tableBody.appendChild(row);
                
                // Update the status after creating the row
                updateRequestStatus(request, row);
            });
        }

        function renderFocusView() {
            const caseData = appData.cases.find(c => c.caseId === currentCaseId);
            if (!caseData) return showDisputeListView(currentLetterId);

            const letterData = caseData.requestLetters.find(l => l.id === currentLetterId);
            if (!letterData) return showDisputeListView(currentLetterId);

            const request = letterData.requests[currentFocusIndex];
            if (!request) return showDisputeListView(currentLetterId);
            
            document.getElementById('focus-title').textContent = `Request ${request.id} of ${letterData.requests.length}`;
            document.getElementById('focus-request-text').textContent = request.text;
            const container = document.getElementById('focus-content-grid');
            
            container.innerHTML = `
                <div class="focus-col">
                    <h4>Opponent's Objection</h4>
                    <textarea id="focus-objection-textarea" class="text-pane">${request.objection || ''}</textarea>
                </div>
                <div class="focus-col">
                     <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4>AI-Generated Replies</h4>
                        <button data-action="focus-generate" class="btn btn-action">Generate</button>
                    </div>
                    <div id="focus-reply-editor" class="text-pane" contenteditable="true">${request.reply || ''}</div>
                </div>
            `;
        }

        // --- NAVIGATION & DATA HANDLING ---
        function goBack() {
            if (document.body.classList.contains('focus-mode-active')) {
                showDisputeListView(currentLetterId);
            } else if (document.body.classList.contains('dispute-list-active')) {
                showRequestLettersView(currentCaseId);
            }
        }
        
        function navigateFocus(direction) {
            if (!document.body.classList.contains('focus-mode-active')) return;
            
            const caseData = appData.cases.find(c => c.caseId === currentCaseId);
            if (!caseData) return;

            const letterData = caseData.requestLetters.find(l => l.id === currentLetterId);
            if (!letterData) return;

            // Save current state before navigation
            const currentRequest = letterData.requests[currentFocusIndex];
            if (currentRequest) {
                currentRequest.objection = document.getElementById('focus-objection-textarea').value;
                currentRequest.reply = document.getElementById('focus-reply-editor').innerHTML;
            }
            
            const newIndex = currentFocusIndex + direction;
            if (newIndex >= 0 && newIndex < letterData.requests.length) {
                showFocusView(newIndex);
            }
        }
        
        async function handleGenerateReplies() {
            const button = document.querySelector('[data-action="focus-generate"]');
            const replyEditor = document.getElementById('focus-reply-editor');
            const caseData = appData.cases.find(c => c.caseId === currentCaseId);
            const request = caseData.requestLetters[currentFocusIndex].requests[currentFocusIndex];
            const objectionText = document.getElementById('focus-objection-textarea').value.trim();

            if (!objectionText) { alert("Please enter an objection first."); return; }
            
            request.objection = objectionText;
            button.disabled = true;
            button.innerHTML = '<div class="loading-spinner"></div>';
            replyEditor.innerHTML = '';

            try {
                const payload = { requestText: request.text, objectionText: objectionText };
                const result = await window.electronAPI.askGemini(payload);
                if (result.success) {
                    request.reply = result.html;
                    replyEditor.innerHTML = result.html;
                } else {
                    replyEditor.innerHTML = `<div style="color:red;">Error: ${result.error}</div>`;
                }
            } catch (error) {
                replyEditor.innerHTML = `<div style="color:red;">A critical error occurred: ${error.message}</div>`;
            } finally {
                button.disabled = false;
                button.textContent = 'Generate';
            }
        }

        async function handleGenerateAllReplies() {
            const button = document.querySelector('[data-action="generate-all"]');
            const progressSection = document.getElementById('dispute-progress-section');
            const statusBar = document.getElementById('dispute-status-bar');
            const progressBar = document.getElementById('dispute-progress-bar');
            
            const caseData = appData.cases.find(c => c.caseId === currentCaseId);
            if (!caseData) return;

            const letterData = caseData.requestLetters.find(l => l.id === currentLetterId);
            if (!letterData) return;

            const requestsToProcess = letterData.requests.filter(r => r.objection && !r.reply);

            if (requestsToProcess.length === 0) {
                alert("No pending replies to generate.");
                return;
            }

            const totalToProcess = requestsToProcess.length;
            button.disabled = true;
            button.innerHTML = '<div class="loading-spinner"></div> Generating...';
            
            // Show progress section
            progressSection.classList.add('visible');
            statusBar.textContent = `Preparing to generate ${totalToProcess} replies...`;
            statusBar.className = 'status-bar status-processing';
            progressBar.style.width = '0%';

            try {
                let completedCount = 0;
                for (const request of requestsToProcess) {
                    // Update progress for current request
                    const progress = (completedCount / totalToProcess) * 100;
                    statusBar.textContent = `Generating reply ${completedCount + 1} of ${totalToProcess} (Request #${request.id})...`;
                    progressBar.style.width = `${progress}%`;
                    
                    const payload = { requestText: request.text, objectionText: request.objection };
                    const result = await window.electronAPI.askGemini(payload);

                    if (result.success) {
                        request.reply = result.html;
                        
                        // Update status in dispute list view if visible
                        if (!document.body.classList.contains('focus-mode-active')) {
                            const disputeRow = document.querySelector(`#table-body tr[data-index="${letterData.requests.indexOf(request)}"]`);
                            if (disputeRow) {
                                updateRequestStatus(request, disputeRow);
                            }
                        }

                        // Update status in request letters view
                        const letterRow = document.querySelector(`#request-letters-table tr[data-letter-id="${letterData.id}"]`);
                        if (letterRow) {
                            updateLetterStatus(letterData, letterRow);
                        }
                        
                        // Update focus view if we're viewing this request
                        if (document.body.classList.contains('focus-mode-active')) {
                            const currentRequest = letterData.requests[currentFocusIndex];
                            if (currentRequest && currentRequest.id === request.id) {
                                const replyEditor = document.getElementById('focus-reply-editor');
                                if (replyEditor) {
                                    replyEditor.innerHTML = result.html;
                                }
                            }
                        }
                    } else {
                        request.reply = `<div style="color:red;">Error generating reply: ${result.error}</div>`;
                        console.error(`Failed to generate reply for request #${request.id}`, result.error);
                    }
                    
                    completedCount++;
                }

                // Update final progress
                statusBar.textContent = 'All pending replies have been generated!';
                statusBar.className = 'status-bar status-success';
                progressBar.style.width = '100%';

                setTimeout(() => {
                    progressSection.classList.remove('visible');
                }, 3000);

            } catch (error) {
                statusBar.textContent = `A critical error occurred: ${error.message}`;
                statusBar.className = 'status-bar status-error';
                setTimeout(() => {
                    progressSection.classList.remove('visible');
                }, 5000);
            } finally {
                button.disabled = false;
                button.textContent = "Generate All Pending Replies";
            }
        }

        // --- INITIALIZATION & EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', showCasesDashboard);

        document.body.addEventListener('click', (event) => {
            const target = event.target;
            const caseCard = target.closest('.case-card');
            const letterRow = target.closest('#request-letters-table tr');
            const disputeRow = target.closest('#table-body tr');
            const action = target.dataset.action;

            if (caseCard) {
                showRequestLettersView(caseCard.dataset.caseId);
            } else if (letterRow) {
                showDisputeListView(letterRow.dataset.letterId);
            } else if (disputeRow) {
                showFocusView(parseInt(disputeRow.dataset.index));
            } else if (action) {
                switch(action) {
                    case 'back-to-cases': showCasesDashboard(); break;
                    case 'back-to-letters': showRequestLettersView(currentCaseId); break;
                    case 'back-to-list': showDisputeListView(currentLetterId); break;
                    case 'focus-next': navigateFocus(1); break;
                    case 'focus-prev': navigateFocus(-1); break;
                    case 'focus-generate': handleGenerateReplies(); break;
                    case 'generate-all': handleGenerateAllReplies(); break;
                    case 'upload-request': window.electronAPI.uploadRequestLetter(); break;
                    case 'upload': 
                        const currentCase = appData.cases.find(c => c.caseId === currentCaseId);
                        const currentLetter = currentCase?.requestLetters.find(l => l.id === currentLetterId);
                        if (currentLetter) {
                            window.electronAPI.uploadAndProcess(currentLetter.requests);
                        }
                        break;
                }
            }
        });

        document.addEventListener('keydown', (event) => {
            if (!document.body.classList.contains('focus-mode-active')) return;

            const activeEl = document.activeElement;
            const isEditingText = activeEl && (activeEl.tagName === 'TEXTAREA' || activeEl.isContentEditable);
            
            if (!isEditingText) {
                if (event.key === 'ArrowRight') {
                    event.preventDefault();
                    navigateFocus(1);
                } else if (event.key === 'ArrowLeft') {
                    event.preventDefault();
                    navigateFocus(-1);
                }
            }
        });
        
        window.electronAPI.onMenuAction((action) => {
            switch(action) {
                case 'go-back': goBack(); break;
                case 'nav-next': navigateFocus(1); break;
                case 'nav-prev': navigateFocus(-1); break;
            }
        });
        
        window.electronAPI.onUploadProgress((result) => {
            const progressSection = document.getElementById('dispute-progress-section');
            const statusBar = document.getElementById('dispute-status-bar');
            const progressBar = document.getElementById('dispute-progress-bar');
            const button = document.querySelector('[data-action="upload"]');
            const currentCase = appData.cases.find(c => c.caseId === currentCaseId);
            const currentLetter = currentCase?.requestLetters.find(l => l.id === currentLetterId);
            if (!currentLetter) return;

            const updateProgress = (message, progress) => {
                statusBar.textContent = message;
                statusBar.className = 'status-bar status-processing';
                progressBar.style.width = `${progress}%`;
            };

            switch (result.type) {
                case 'progress':
                    progressSection.classList.add('visible');
                    button.disabled = true;
                    button.innerHTML = '<div class="loading-spinner"></div> Processing...';
                    updateProgress(result.message, result.progress);
                    break;

                case 'complete':
                    if (result.data && Array.isArray(result.data)) {
                        result.data.forEach(obj => {
                            const requestToUpdate = currentLetter.requests.find(r => r.id === obj.id);
                            if (requestToUpdate) {
                                requestToUpdate.objection = obj.objection;
                            }
                        });
                        renderDisputeListView();
                    }
                    statusBar.className = 'status-bar status-success';
                    updateProgress('Processing complete! All objections extracted.', 100);
                    button.disabled = false;
                    button.innerHTML = "Upload Opponent's Response";
                    setTimeout(() => {
                        progressSection.classList.remove('visible');
                    }, 3000);
                    break;

                case 'error':
                    progressSection.classList.add('visible');
                    statusBar.className = 'status-bar status-error';
                    updateProgress(`Error: ${result.message}`, 100);
                    button.disabled = false;
                    button.innerHTML = "Upload Opponent's Response";
                    setTimeout(() => {
                        progressSection.classList.remove('visible');
                    }, 5000);
                    break;

                case 'cancel':
                    button.disabled = false;
                    button.innerHTML = "Upload Opponent's Response";
                    progressSection.classList.remove('visible');
                    break;
            }
        });

        window.electronAPI.onRequestProgress((result) => {
            const progressSection = document.getElementById('request-progress-section');
            const statusBar = document.getElementById('request-status-bar');
            const progressBar = document.getElementById('request-progress-bar');
            const button = document.querySelector('[data-action="upload-request"]');
            const currentCase = appData.cases.find(c => c.caseId === currentCaseId);
            if (!currentCase) return;

            const updateProgress = (message, progress) => {
                statusBar.textContent = message;
                progressBar.style.width = `${progress}%`;
            };

            switch (result.type) {
                case 'progress':
                    progressSection.classList.add('visible');
                    button.disabled = true;
                    button.innerHTML = '<div class="loading-spinner"></div> Processing...';
                    updateProgress(result.message, result.progress);
                    break;

                case 'complete':
                    if (result.data && Array.isArray(result.data)) {
                        const newLetter = {
                            id: `rog-set${currentCase.requestLetters.length + 1}`,
                            dateAdded: new Date().toISOString().split('T')[0],
                            description: `Set ${currentCase.requestLetters.length + 1} of Interrogatories`,
                            requests: result.data.map(req => ({
                                ...req,
                                objection: null,
                                reply: null
                            }))
                        };
                        currentCase.requestLetters.push(newLetter);
                        renderRequestLettersView();
                    }
                    statusBar.className = 'status-bar status-success';
                    updateProgress('Processing complete! New request letter added.', 100);
                    button.disabled = false;
                    button.innerHTML = 'Upload Request Letter';
                    setTimeout(() => {
                        progressSection.classList.remove('visible');
                    }, 3000);
                    break;

                case 'error':
                    progressSection.classList.add('visible');
                    statusBar.className = 'status-bar status-error';
                    updateProgress(`Error: ${result.message}`, 100);
                    button.disabled = false;
                    button.innerHTML = 'Upload Request Letter';
                    setTimeout(() => {
                        progressSection.classList.remove('visible');
                    }, 5000);
                    break;

                case 'cancel':
                    button.disabled = false;
                    button.innerHTML = 'Upload Request Letter';
                    progressSection.classList.remove('visible');
                    break;
            }
        });
    </script>
</body>
</html>